<!DOCTYPE html>
<html lang='en'>
<head>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
<meta content='width=device-width, initial-scale=1' name='viewport'>
<meta content='IE=edge' http-equiv='X-UA-Compatible'>
<meta content='no' name='msapplication-tap-highlight'>
<meta content='Aparapi is an Open-source framework for executing native Java code on the GPU, developed by Syncleus.' name='description'>
<title>
Aparapi | Emulating Multiple Entrypoints
</title>
<!-- Favicons -->
<link href='/images/favicon/apple-touch-icon-152x152.png' rel='apple-touch-icon-precomposed'>
<meta content='#FFFFFF' name='msapplication-TileColor'>
<meta content='/images/favicon/mstile-144x144.png' name='msapplication-TileImage'>
<link href='/images/favicon/favicon-32x32.png' rel='icon' sizes='32x32'>
<!-- Android 5 Chrome Color -->
<meta content='#EE6E73' name='theme-color'>
<!-- CSS -->
<link href='/stylesheets/highlight.css' media='screen,projection' rel='stylesheet' type='text/css'>
<link href='/stylesheets/style.css' media='screen,projection' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/icon?family=Material+Icons' rel='stylesheet'>
</head>
<body>
<header>
<div class='container'>
<a class='button-collapse top-nav waves-effect waves-light circle hide-on-large-only' data-activates='nav-mobile' href='#'>
<i class='material-icons'>menu</i>
</a>
</div>
<ul class='side-nav fixed' id='nav-mobile'>
<li class='logo'>
<a class='brand-logo' href='/' id='logo-container'>
<object data='/images/logo.svg' id='front-page-logo' type='image/svg+xml'>Your browser does not support SVG</object>
</a>
</li>
<li class='search'>
<div class='search-wrapper card'>
<input id='search'>
<i class='material-icons'>search</i>
<div class='search-results'></div>
</div>
</li>
<li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/">Overview</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a class='collapsible-header waves-effect waves-teal'>Introduction</a><div class='collapsible-body'><ul><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/introduction/about.html">About</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/introduction/getting-started.html">Getting Started</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/introduction/faq.html">FAQ</a></li></ul></li></ul></div></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a class='collapsible-header waves-effect waves-teal'>Documentation</a><div class='collapsible-body'><ul><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/aparapi-patterns.html">Aparapi Patterns</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/choosing-specific-devices.html">Choosing Specific Devices</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/converting-java-to-opencl.html">Converting Java to OpenCL</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/emulating-multiple-entrypoints.html">Emulating Multiple Entrypoints</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/explicit-buffer-handling.html">Explicit Buffer Handling</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/hsa-enabled-lambda.html">HSA Enabled Lambda</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/kernel-guidelines.html">Kernel Guidelines</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/library-agent-duality.html">Library Agent Duality</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/new-features.html">New Features</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/opencl-bindings.html">OpenCL Bindings</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/private-memory-space.html">Private Memory Space</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/profiling-the-kernel.html">Profiling the Kernel</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/setting-up-hsa.html">Setting Up HSA</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/unit-tests.html">Unit Tests</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/using-hsa-simulator.html">Using HSA Simulator</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/constant-memory.html">Constant Memory</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/local-memory.html">Local Memory</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/multiple-dim-ranges.html">Multiple Dim Ranges</a></li></ul></li></ul></div></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a class='collapsible-header waves-effect waves-teal'>Proposals</a><div class='collapsible-body'><ul><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/proposals/multiple-dim-nd-range.html">Multiple Dim ND Range</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/proposals/lambdas.html">Lambdas</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/proposals/address-space-with-buffers.html">Address Space with Buffers</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/proposals/extensions.html">Extensions</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/proposals/device.html">Device</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/proposals/multiple-entry-points.html">Multiple Entry Points</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/proposals/lambda-syntax.html">Lambda Syntax</a></li></ul></li></ul></div></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/showcase.html">Showcase</a></li></ul></li>
</ul>
</header>
<main>
<div class='section no-pad-bot' id='index-banner'>
<div class='container'>
<h1 class='header center-on-small-only'>Emulating Multiple Entrypoints</h1>
<div class='row center'>
<h4 class='header col s12 light center'>How to emulate multiple entrypoints using existing Aparapi APIs</h4>
</div>

</div>

</div>
<div class='container'>
<h2>Emulating Multiple Entrypoints Using Existing Aparapi APIs</h2>

<p>Until we have support for multiple entrypoints in Aparapi, there are some tricks for emulating this feature.</p>

<p>Suppose we wanted to create a general VectorMath kernel which might expose unary square, squareroot methods and binary addition and subtraction functionality. With our current API limitations we can&rsquo;t easily do this, we can approximate having separate methods by passing a separate arg to dictate the &lsquo;function&rsquo; that we wish to perform.</p>
<div class="highlight"><pre class="highlight java"><code>
<span class="kd">class</span> <span class="nc">VectorKernel</span> <span class="kd">extends</span> <span class="n">Kernel</span><span class="o">{</span>
    <span class="kt">float</span><span class="o">[]</span> <span class="n">lhsOperand</span><span class="o">;</span>
    <span class="kt">float</span><span class="o">[]</span> <span class="n">rhsOperand</span><span class="o">;</span>
    <span class="kt">float</span><span class="o">[]</span> <span class="n">unaryOperand</span><span class="o">;</span>
    <span class="kt">float</span><span class="o">[]</span> <span class="n">result</span><span class="o">;</span>
    <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">FUNC_ADD</span> <span class="o">=</span><span class="mi">0</span><span class="o">;</span>
    <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">FUNC_SUB</span> <span class="o">=</span><span class="mi">1</span><span class="o">;</span>
    <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">FUNC_SQR</span> <span class="o">=</span><span class="mi">2</span><span class="o">;</span>
    <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">FUNC_SQRT</span> <span class="o">=</span><span class="mi">3</span><span class="o">;</span>
    <span class="c1">// other functions</span>
    <span class="kt">int</span> <span class="n">function</span><span class="o">;</span>
    <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(){</span>
        <span class="kt">int</span> <span class="n">gid</span> <span class="o">=</span> <span class="n">getGlobalId</span><span class="o">(</span><span class="mi">0</span><span class="o">){</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">function</span><span class="o">==</span><span class="n">FUNC_ADD</span><span class="o">){</span>
           <span class="n">result</span><span class="o">[</span><span class="n">gid</span><span class="o">]=</span><span class="n">lhsOperand</span><span class="o">[</span><span class="n">gid</span><span class="o">]+</span><span class="n">rhsOperand</span><span class="o">[</span><span class="n">gid</span><span class="o">];</span>
        <span class="o">}</span><span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">function</span><span class="o">==</span><span class="n">FUNC_SUB</span><span class="o">){</span>
           <span class="n">result</span><span class="o">[</span><span class="n">gid</span><span class="o">]=</span><span class="n">lhsOperand</span><span class="o">[</span><span class="n">gid</span><span class="o">]-</span><span class="n">rhsOperand</span><span class="o">[</span><span class="n">gid</span><span class="o">];</span>
        <span class="o">}</span><span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">function</span><span class="o">==</span><span class="n">FUNC_SQR</span><span class="o">){</span>
           <span class="n">result</span><span class="o">[</span><span class="n">gid</span><span class="o">]=</span><span class="n">unaryOperand</span><span class="o">[</span><span class="n">gid</span><span class="o">]*</span><span class="n">unaryOperand</span><span class="o">[</span><span class="n">gid</span><span class="o">];</span>
        <span class="o">}</span><span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">function</span><span class="o">==</span><span class="n">FUNC_ADD</span><span class="o">){</span>
           <span class="n">result</span><span class="o">[</span><span class="n">gid</span><span class="o">]=</span><span class="n">sqrt</span><span class="o">(</span><span class="n">unaryOperand</span><span class="o">[</span><span class="n">gid</span><span class="o">]);</span>
        <span class="o">}</span><span class="k">else</span> <span class="k">if</span> <span class="o">....</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>To use this for adding two vectors and then take the sqrt of the result we would use something like&hellip;.</p>
<div class="highlight"><pre class="highlight java"><code>
<span class="kt">int</span> <span class="n">SIZE</span><span class="o">=</span><span class="mi">1024</span><span class="o">;</span>
<span class="n">Range</span> <span class="n">range</span> <span class="o">=</span> <span class="n">Range</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">SIZE</span><span class="o">);</span>
<span class="n">VectorKernel</span> <span class="n">vk</span> <span class="o">=</span> <span class="k">new</span> <span class="n">VectorKernel</span><span class="o">();</span>
<span class="n">vk</span><span class="o">.</span><span class="na">lhsOperand</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">float</span><span class="o">[</span><span class="n">SIZE</span><span class="o">];</span>
<span class="n">vk</span><span class="o">.</span><span class="na">rhsOperand</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">float</span><span class="o">[</span><span class="n">SIZE</span><span class="o">];</span>
<span class="n">vk</span><span class="o">.</span><span class="na">unaryOperand</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">float</span><span class="o">[</span><span class="n">SIZE</span><span class="o">];</span>
<span class="n">vk</span><span class="o">.</span><span class="na">result</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">float</span><span class="o">[</span><span class="n">SIZE</span><span class="o">];</span>

<span class="c1">// fill lhsOperand ommitted</span>
<span class="c1">// fill rhsOperand ommitted</span>
<span class="n">vk</span><span class="o">.</span><span class="na">function</span> <span class="o">=</span> <span class="n">VectorKernel</span><span class="o">.</span><span class="na">FUNC_ADD</span><span class="o">;</span>
<span class="n">vk</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">range</span><span class="o">);</span>
<span class="n">System</span><span class="o">.</span><span class="na">arrayCopy</span><span class="o">(</span><span class="n">vk</span><span class="o">.</span><span class="na">result</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">vk</span><span class="o">.</span><span class="na">unaryOperand</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">SIZE</span><span class="o">);</span>
<span class="n">vk</span><span class="o">.</span><span class="na">function</span> <span class="o">=</span> <span class="n">VectorKernel</span><span class="o">.</span><span class="na">FUNC_SQRT</span><span class="o">;</span>
<span class="n">vk</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">range</span><span class="o">);</span>
</code></pre></div>
<p>This approach is fairly common and I have used it successfully to perform various pipeline stages for calculating FFT&rsquo;s for example. Whilst this is functional it is not a great solution. First the API is clumsy. We have to mutate the state of the kernel instance and then re-arrange the arrays manually to chain math operations. We could of course hide all of this behind helper methods. One could imagine for example an implementation which exposes helper add(lhs, rhs)}}, or {{{sqrt() which hid all the nasty stuff.</p>
<div class="highlight"><pre class="highlight java"><code>
<span class="kd">class</span> <span class="nc">VectorKernel</span> <span class="kd">extends</span> <span class="n">Kernel</span><span class="o">{</span>
    <span class="kt">float</span><span class="o">[]</span> <span class="n">lhsOperand</span><span class="o">;</span>
    <span class="kt">float</span><span class="o">[]</span> <span class="n">rhsOperand</span><span class="o">;</span>
    <span class="kt">float</span><span class="o">[]</span> <span class="n">unaryOperand</span><span class="o">;</span>
    <span class="kt">float</span><span class="o">[]</span> <span class="n">result</span><span class="o">;</span>
    <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">FUNC_ADD</span> <span class="o">=</span><span class="mi">0</span><span class="o">;</span>
    <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">FUNC_SUB</span> <span class="o">=</span><span class="mi">1</span><span class="o">;</span>
    <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">FUNC_SQR</span> <span class="o">=</span><span class="mi">2</span><span class="o">;</span>
    <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">FUNC_SQRT</span> <span class="o">=</span><span class="mi">3</span><span class="o">;</span>
    <span class="c1">// other functions</span>
    <span class="kt">int</span> <span class="n">function</span><span class="o">;</span>
    <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(){</span>
        <span class="kt">int</span> <span class="n">gid</span> <span class="o">=</span> <span class="n">getGlobalId</span><span class="o">(</span><span class="mi">0</span><span class="o">){</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">function</span><span class="o">==</span><span class="n">FUNC_ADD</span><span class="o">){</span>
           <span class="n">result</span><span class="o">[</span><span class="n">gid</span><span class="o">]=</span><span class="n">lhsOperand</span><span class="o">[</span><span class="n">gid</span><span class="o">]+</span><span class="n">rhsOperand</span><span class="o">[</span><span class="n">gid</span><span class="o">];</span>
        <span class="o">}</span><span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">function</span><span class="o">==</span><span class="n">FUNC_SUB</span><span class="o">){</span>
           <span class="n">result</span><span class="o">[</span><span class="n">gid</span><span class="o">]=</span><span class="n">lhsOperand</span><span class="o">[</span><span class="n">gid</span><span class="o">]-</span><span class="n">rhsOperand</span><span class="o">[</span><span class="n">gid</span><span class="o">];</span>
        <span class="o">}</span><span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">function</span><span class="o">==</span><span class="n">FUNC_SQR</span><span class="o">){</span>
           <span class="n">result</span><span class="o">[</span><span class="n">gid</span><span class="o">]=</span><span class="n">unaryOperand</span><span class="o">[</span><span class="n">gid</span><span class="o">]*</span><span class="n">unaryOperand</span><span class="o">[</span><span class="n">gid</span><span class="o">];</span>
        <span class="o">}</span><span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">function</span><span class="o">==</span><span class="n">FUNC_ADD</span><span class="o">){</span>
           <span class="n">result</span><span class="o">[</span><span class="n">gid</span><span class="o">]=</span><span class="n">sqrt</span><span class="o">(</span><span class="n">unaryOperand</span><span class="o">[</span><span class="n">gid</span><span class="o">]);</span>
        <span class="o">}</span><span class="k">else</span> <span class="k">if</span> <span class="o">....</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">binary</span><span class="o">(</span><span class="kt">int</span> <span class="n">operator</span><span class="o">,</span> <span class="kt">float</span><span class="o">[]</span> <span class="n">lhs</span><span class="o">,</span> <span class="kt">float</span><span class="o">[]</span> <span class="n">rhs</span><span class="o">){</span>
       <span class="n">lhsOperand</span> <span class="o">=</span> <span class="n">lhs</span><span class="o">;</span>
       <span class="n">rhsOperand</span> <span class="o">=</span> <span class="n">rhs</span><span class="o">;</span>
       <span class="n">function</span><span class="o">=</span><span class="n">operator</span><span class="o">;</span>
       <span class="n">execute</span><span class="o">(</span><span class="n">lhs</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="kt">float</span><span class="o">[]</span> <span class="n">lhs</span><span class="o">,</span> <span class="kt">float</span><span class="o">[]</span> <span class="n">rhs</span><span class="o">){</span>
       <span class="n">binary</span><span class="o">(</span><span class="n">FUNC_ADD</span><span class="o">,</span> <span class="n">lhs</span><span class="o">,</span> <span class="n">rhs</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sub</span><span class="o">(</span><span class="kt">float</span><span class="o">[]</span> <span class="n">lhs</span><span class="o">,</span> <span class="kt">float</span><span class="o">[]</span> <span class="n">rhs</span><span class="o">){</span>
       <span class="n">binary</span><span class="o">(</span><span class="n">FUNC_SUB</span><span class="o">,</span> <span class="n">lhs</span><span class="o">,</span> <span class="n">rhs</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">binary</span><span class="o">(</span><span class="kt">int</span> <span class="n">operator</span><span class="o">,</span> <span class="kt">float</span><span class="o">[]</span> <span class="n">rhs</span><span class="o">){</span>
       <span class="n">System</span><span class="o">.</span><span class="na">arrayCopy</span><span class="o">(</span><span class="n">result</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">lhsOperand</span><span class="o">,</span> <span class="n">result</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
       <span class="n">rhsOperand</span> <span class="o">=</span> <span class="n">rhs</span><span class="o">;</span>
       <span class="n">function</span><span class="o">=</span><span class="n">operator</span><span class="o">;</span>
       <span class="n">execute</span><span class="o">(</span><span class="n">lhsOperand</span><span class="o">.</span><span class="na">legth</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="kt">float</span><span class="o">[]</span> <span class="n">rhs</span><span class="o">){</span>
       <span class="n">binary</span><span class="o">(</span><span class="n">FUNC_ADD</span><span class="o">,</span>  <span class="n">rhs</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sub</span><span class="o">(</span> <span class="kt">float</span><span class="o">[]</span> <span class="n">rhs</span><span class="o">){</span>
       <span class="n">binary</span><span class="o">(</span><span class="n">FUNC_SUB</span><span class="o">,</span>  <span class="n">rhs</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">unary</span><span class="o">(</span><span class="kt">int</span> <span class="n">operator</span><span class="o">,</span> <span class="kt">float</span><span class="o">[]</span> <span class="n">unary</span><span class="o">){</span>
       <span class="n">unaryOperand</span> <span class="o">=</span> <span class="n">unary</span><span class="o">;</span>
       <span class="n">function</span><span class="o">=</span><span class="n">operator</span><span class="o">;</span>
       <span class="n">execute</span><span class="o">(</span><span class="n">unaryOperand</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sqrt</span><span class="o">(</span><span class="kt">float</span><span class="o">[]</span> <span class="n">unary</span><span class="o">){</span>
       <span class="n">unary</span><span class="o">(</span><span class="n">FUNC_SQRT</span><span class="o">,</span> <span class="n">unary</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">unary</span><span class="o">(</span><span class="kt">int</span> <span class="n">operator</span><span class="o">){</span>
       <span class="n">System</span><span class="o">.</span><span class="na">array</span><span class="o">.</span><span class="na">copy</span><span class="o">(</span><span class="n">result</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">unaryOperand</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">result</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
       <span class="n">function</span><span class="o">=</span><span class="n">operator</span><span class="o">;</span>
       <span class="n">execute</span><span class="o">(</span><span class="n">unaryOperand</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sqrt</span><span class="o">(){</span>
       <span class="n">unary</span><span class="o">(</span><span class="n">FUNC_SQRT</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>

<span class="n">VectorKernel</span> <span class="n">vk</span> <span class="o">=</span> <span class="k">new</span> <span class="n">VectorKernel</span><span class="o">(</span><span class="n">SIZE</span><span class="o">);</span>
<span class="n">vk</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">copyLhs</span><span class="o">,</span> <span class="n">copyRhs</span><span class="o">);</span>  <span class="c1">// copies args to lhs and rhs operands</span>
                           <span class="c1">// sets function type</span>
                           <span class="c1">// and executes kernel</span>
<span class="n">vk</span><span class="o">.</span><span class="na">sqrt</span><span class="o">();</span>                 <span class="c1">// because we have no arg</span>
                           <span class="c1">// copies result to unary operand</span>
                           <span class="c1">// sets function type</span>
                           <span class="c1">// execute kernel</span>
</code></pre></div>
<p>However there is one more objection to this approach, namely that it by default will force unnecessarily buffer copies.</p>

<p>When the bytecode for the above <code>Kernel.run()</code> method is analyzed Aparapi finds bytecode reading from lhsOperand, rhsOperand and unaryOperand arrays/buffers. Obviously at this bytecode analysis stage we can&rsquo;t predict which &lsquo;function type&rsquo; will be used, so on every executions (Kernel.run()) Aparapi must copy all three buffers to the GPU. For binary operations this is one buffer copy wasted (the unaryOperand), for the unary operations we copy two buffers unnecessarily (lhsOperand and rhsOperand). We can of course use explicit buffer management to help us reduce these costs. Ideally we add this to our helper methods.</p>
<div class="highlight"><pre class="highlight java"><code>
<span class="kd">class</span> <span class="nc">VectorKernel</span> <span class="kd">extends</span> <span class="n">Kernel</span><span class="o">{</span>
    <span class="kt">float</span><span class="o">[]</span> <span class="n">lhsOperand</span><span class="o">;</span>
    <span class="kt">float</span><span class="o">[]</span> <span class="n">rhsOperand</span><span class="o">;</span>
    <span class="kt">float</span><span class="o">[]</span> <span class="n">unaryOperand</span><span class="o">;</span>
    <span class="kt">float</span><span class="o">[]</span> <span class="n">result</span><span class="o">;</span>
    <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">FUNC_ADD</span> <span class="o">=</span><span class="mi">0</span><span class="o">;</span>
    <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">FUNC_SUB</span> <span class="o">=</span><span class="mi">1</span><span class="o">;</span>
    <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">FUNC_SQR</span> <span class="o">=</span><span class="mi">2</span><span class="o">;</span>
    <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">FUNC_SQRT</span> <span class="o">=</span><span class="mi">3</span><span class="o">;</span>
    <span class="c1">// other functions</span>
    <span class="kt">int</span> <span class="n">function</span><span class="o">;</span>
    <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(){</span>
        <span class="kt">int</span> <span class="n">gid</span> <span class="o">=</span> <span class="n">getGlobalId</span><span class="o">(</span><span class="mi">0</span><span class="o">){</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">function</span><span class="o">==</span><span class="n">FUNC_ADD</span><span class="o">){</span>
           <span class="n">result</span><span class="o">[</span><span class="n">gid</span><span class="o">]=</span><span class="n">lhsOperand</span><span class="o">[</span><span class="n">gid</span><span class="o">]+</span><span class="n">rhsOperand</span><span class="o">[</span><span class="n">gid</span><span class="o">];</span>
        <span class="o">}</span><span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">function</span><span class="o">==</span><span class="n">FUNC_SUB</span><span class="o">){</span>
           <span class="n">result</span><span class="o">[</span><span class="n">gid</span><span class="o">]=</span><span class="n">lhsOperand</span><span class="o">[</span><span class="n">gid</span><span class="o">]-</span><span class="n">rhsOperand</span><span class="o">[</span><span class="n">gid</span><span class="o">];</span>
        <span class="o">}</span><span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">function</span><span class="o">==</span><span class="n">FUNC_SQR</span><span class="o">){</span>
           <span class="n">result</span><span class="o">[</span><span class="n">gid</span><span class="o">]=</span><span class="n">unaryOperand</span><span class="o">[</span><span class="n">gid</span><span class="o">]*</span><span class="n">unaryOperand</span><span class="o">[</span><span class="n">gid</span><span class="o">];</span>
        <span class="o">}</span><span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">function</span><span class="o">==</span><span class="n">FUNC_ADD</span><span class="o">){</span>
           <span class="n">result</span><span class="o">[</span><span class="n">gid</span><span class="o">]=</span><span class="n">sqrt</span><span class="o">(</span><span class="n">unaryOperand</span><span class="o">[</span><span class="n">gid</span><span class="o">]);</span>
        <span class="o">}</span><span class="k">else</span> <span class="k">if</span> <span class="o">....</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">binary</span><span class="o">(</span><span class="kt">int</span> <span class="n">operator</span><span class="o">,</span> <span class="kt">float</span><span class="o">[]</span> <span class="n">lhs</span><span class="o">,</span> <span class="kt">float</span><span class="o">[]</span> <span class="n">rhs</span><span class="o">){</span>
       <span class="n">lhsOperand</span> <span class="o">=</span> <span class="n">lhs</span><span class="o">;</span>
       <span class="n">rhsOperand</span> <span class="o">=</span> <span class="n">rhs</span><span class="o">;</span>
       <span class="n">function</span><span class="o">=</span><span class="n">operator</span><span class="o">;</span>
       <span class="n">put</span><span class="o">(</span><span class="n">lhsOperand</span><span class="o">).</span><span class="na">put</span><span class="o">(</span><span class="n">rhsOperand</span><span class="o">);</span>
       <span class="n">execute</span><span class="o">(</span><span class="n">lhs</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
       <span class="n">get</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="kt">float</span><span class="o">[]</span> <span class="n">lhs</span><span class="o">,</span> <span class="kt">float</span><span class="o">[]</span> <span class="n">rhs</span><span class="o">){</span>
       <span class="n">binary</span><span class="o">(</span><span class="n">FUNC_ADD</span><span class="o">,</span> <span class="n">lhs</span><span class="o">,</span> <span class="n">rhs</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sub</span><span class="o">(</span><span class="kt">float</span><span class="o">[]</span> <span class="n">lhs</span><span class="o">,</span> <span class="kt">float</span><span class="o">[]</span> <span class="n">rhs</span><span class="o">){</span>
       <span class="n">binary</span><span class="o">(</span><span class="n">FUNC_SUB</span><span class="o">,</span> <span class="n">lhs</span><span class="o">,</span> <span class="n">rhs</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">binary</span><span class="o">(</span><span class="kt">int</span> <span class="n">operator</span><span class="o">,</span> <span class="kt">float</span><span class="o">[]</span> <span class="n">rhs</span><span class="o">){</span>
       <span class="n">System</span><span class="o">.</span><span class="na">arrayCopy</span><span class="o">(</span><span class="n">result</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">lhsOperand</span><span class="o">,</span> <span class="n">result</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
       <span class="n">rhsOperand</span> <span class="o">=</span> <span class="n">rhs</span><span class="o">;</span>
       <span class="n">function</span><span class="o">=</span><span class="n">operator</span><span class="o">;</span>
       <span class="n">put</span><span class="o">(</span><span class="n">lhsOperand</span><span class="o">).</span><span class="na">put</span><span class="o">(</span><span class="n">rhsOperand</span><span class="o">);</span>
       <span class="n">execute</span><span class="o">(</span><span class="n">lhsOperand</span><span class="o">.</span><span class="na">legth</span><span class="o">());</span>
       <span class="n">get</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="kt">float</span><span class="o">[]</span> <span class="n">rhs</span><span class="o">){</span>
       <span class="n">binary</span><span class="o">(</span><span class="n">FUNC_ADD</span><span class="o">,</span>  <span class="n">rhs</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sub</span><span class="o">(</span> <span class="kt">float</span><span class="o">[]</span> <span class="n">rhs</span><span class="o">){</span>
       <span class="n">binary</span><span class="o">(</span><span class="n">FUNC_SUB</span><span class="o">,</span>  <span class="n">rhs</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">unary</span><span class="o">(</span><span class="kt">int</span> <span class="n">operator</span><span class="o">,</span> <span class="kt">float</span><span class="o">[]</span> <span class="n">unary</span><span class="o">){</span>
       <span class="n">unaryOperand</span> <span class="o">=</span> <span class="n">unary</span><span class="o">;</span>
       <span class="n">function</span><span class="o">=</span><span class="n">operator</span><span class="o">;</span>
       <span class="n">put</span><span class="o">(</span><span class="n">unaryOperand</span><span class="o">);</span>
       <span class="n">execute</span><span class="o">(</span><span class="n">unaryOperand</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
       <span class="n">get</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sqrt</span><span class="o">(</span><span class="kt">float</span><span class="o">[]</span> <span class="n">unary</span><span class="o">){</span>
       <span class="n">unary</span><span class="o">(</span><span class="n">FUNC_SQRT</span><span class="o">,</span> <span class="n">unary</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">unary</span><span class="o">(</span><span class="kt">int</span> <span class="n">operator</span><span class="o">){</span>
       <span class="n">System</span><span class="o">.</span><span class="na">array</span><span class="o">.</span><span class="na">copy</span><span class="o">(</span><span class="n">result</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">unaryOperand</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">result</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
       <span class="n">function</span><span class="o">=</span><span class="n">operator</span><span class="o">;</span>
       <span class="n">put</span><span class="o">(</span><span class="n">unaryOperand</span><span class="o">);</span>
       <span class="n">execute</span><span class="o">(</span><span class="n">unaryOperand</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
       <span class="n">get</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>

    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sqrt</span><span class="o">(){</span>
       <span class="n">unary</span><span class="o">(</span><span class="n">FUNC_SQRT</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div>
</div>
</main>
<footer class='page-footer'>
<div class='container'>
<div class='row'>
<div class='col l4 s12'>
<h5 class='white-text'>Help Aparapi Grow</h5>
<p class='grey-text text-lighten-4'>We are a team of volunteers working on this project like it's our full time job. Any amount would help support and continue development on this project and is greatly appreciated.</p>
<form action='https://www.paypal.com/cgi-bin/webscr' id='paypal-donate' method='post' target='_top'>
<input name='cmd' type='hidden' value='_s-xclick'>
<input name='encrypted' type='hidden' value='-----BEGIN PKCS7-----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-----END PKCS7-----
'>
<button alt='PayPal - The safer, easier way to pay online!' class='btn waves-effect waves-light red lighten-3' name='action' type='submit'>
Donate Now
</button>
</form>
</div>
<div class='col l4 s12'>
<h5 class='white-text'>Join the Discussion</h5>
<p class='grey-text text-lighten-4'>We have a Gitter chat room set up where you can talk directly with us. Come in and discuss new features, future goals, general problems or questions, or anything else you can think of.</p>
<a class='btn waves-effect waves-light red lighten-3' href='https://gitter.im/Syncleus/aparapi' target='_blank'>Chat</a>
</div>
<div class='col l4 s12' style='overflow: hidden;'>
<h5 class='white-text'>Connect</h5>
<iframe allowtransparency='true' frameborder='0' height='30' scrolling='0' src='http://ghbtns.com/github-btn.html?user=Syncleus&amp;repo=aparapi&amp;type=watch&amp;count=true&amp;size=large' width='170'></iframe>
<br>
<a class='twitter-follow-button' data-dnt='true' data-show-count='true' data-size='large' href='https://twitter.com/AparapiLib'>Follow @AparapiLib</a>
<br>
<div class='g-follow' data-annotation='bubble' data-height='24' data-href='https://plus.google.com/102266131584900704956' data-rel='publisher'></div>
</div>
</div>
</div>
<div class='footer-copyright'>
<div class='container'>
© 2016-2017 Syncleus, All rights reserved.
<a class='grey-text text-lighten-4 right' href='https://github.com/Syncleus/aparapi/blob/master/LICENSE'>Apache License v2</a>
</div>
</div>
</footer>
<!-- Scripts -->
<script src='https://code.jquery.com/jquery-2.1.4.min.js'></script>
<script>
  if (!window.jQuery) { document.write('<script src="bin/jquery-2.1.1.min.js"><\/script>'); }
</script>
<script src='/javascripts/jquery.timeago.js'></script>
<script src='/javascripts/materialize.min.js'></script>
<script src='/javascripts/lunr.min.js'></script>
<script src='/javascripts/search.js'></script>
<script src='/javascripts/materialize.js'></script>
<script src='/javascripts/init.js'></script>
<!-- Twitter Button -->
<script>
  !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');
</script>
<!-- Google Plus Button -->
<script async='' defer='defer' src='https://apis.google.com/js/platform.js'></script>
</body>
</html>
