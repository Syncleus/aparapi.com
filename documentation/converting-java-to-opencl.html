<!DOCTYPE html>
<html lang='en'>
  <head>
    <meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
    <meta content='width=device-width, initial-scale=1' name='viewport'>
    <meta content='IE=edge' http-equiv='X-UA-Compatible'>
    <meta content='no' name='msapplication-tap-highlight'>
    <meta content='Aparapi is an Open-source framework for executing native Java code on the GPU, developed by Syncleus.' name='description'>
    <title>
      Aparapi | Converting Java to OpenCL
    </title>
    <!-- Favicons -->
    <link href='/images/favicon/apple-touch-icon-152x152.png' rel='apple-touch-icon-precomposed'>
    <meta content='#FFFFFF' name='msapplication-TileColor'>
    <meta content='/images/favicon/mstile-144x144.png' name='msapplication-TileImage'>
    <link href='/images/favicon/favicon-32x32.png' rel='icon' sizes='32x32'>
    <!-- Android 5 Chrome Color -->
    <meta content='#EE6E73' name='theme-color'>
    <!-- CSS -->
    <link href='/stylesheets/highlight.css' media='screen,projection' rel='stylesheet' type='text/css'>
    <link href='/stylesheets/style.css' media='screen,projection' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/icon?family=Material+Icons' rel='stylesheet'>
  </head>
  <body>
    <header>
      <div class='container'>
        <a class='button-collapse top-nav waves-effect waves-light circle hide-on-large-only' data-activates='nav-mobile' href='#'>
          <i class='material-icons'>menu</i>
        </a>
      </div>
      <ul class='side-nav fixed' id='nav-mobile'>
        <li class='logo'>
          <a class='brand-logo' href='/' id='logo-container'>
            <object data='/images/logo.svg' id='front-page-logo' type='image/svg+xml'>Your browser does not support SVG</object>
          </a>
        </li>
        <li class='search'>
          <div class='search-wrapper card'>
            <input id='search'>
            <i class='material-icons'>search</i>
            <div class='search-results'></div>
          </div>
        </li>
        <li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/">Overview</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a class='collapsible-header waves-effect waves-teal'>Introduction</a><div class='collapsible-body'><ul><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/introduction/about.html">About</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/introduction/getting-started.html">Getting Started</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/introduction/faq.html">FAQ</a></li></ul></li></ul></div></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a class='collapsible-header waves-effect waves-teal'>Documentation</a><div class='collapsible-body'><ul><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/aparapi-patterns.html">Aparapi Patterns</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/choosing-specific-devices.html">Choosing Specific Devices</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/converting-java-to-opencl.html">Converting Java to OpenCL</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/emulating-multiple-entrypoints.html">Emulating Multiple Entrypoints</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/explicit-buffer-handling.html">Explicit Buffer Handling</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/hsa-enabled-lambda.html">HSA Enabled Lambda</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/kernel-guidelines.html">Kernel Guidelines</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/library-agent-duality.html">Library Agent Duality</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/new-features.html">New Features</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/opencl-bindings.html">OpenCL Bindings</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/private-memory-space.html">Private Memory Space</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/profiling-the-kernel.html">Profiling the Kernel</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/setting-up-hsa.html">Setting Up HSA</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/unit-tests.html">Unit Tests</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/using-hsa-simulator.html">Using HSA Simulator</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/constant-memory.html">Constant Memory</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/local-memory.html">Local Memory</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/multiple-dim-ranges.html">Multiple Dim Ranges</a></li></ul></li></ul></div></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a class='collapsible-header waves-effect waves-teal'>Proposals</a><div class='collapsible-body'><ul><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/proposals/multiple-dim-nd-range.html">Multiple Dim ND Range</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/proposals/lambdas.html">Lambdas</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/proposals/address-space-with-buffers.html">Address Space with Buffers</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/proposals/extensions.html">Extensions</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/proposals/device.html">Device</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/proposals/multiple-entry-points.html">Multiple Entry Points</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/proposals/lambda-syntax.html">Lambda Syntax</a></li></ul></li></ul></div></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/showcase.html">Showcase</a></li></ul></li>
      </ul>
    </header>
    <main>
      <div class='section no-pad-bot' id='index-banner'>
        <div class='container'>
          <h1 class='header center-on-small-only'>Converting Java to OpenCL</h1>
          <div class='row center'>
            <h4 class='header col s12 light center'>How Aparapi converts bytecode to OpenCL</h4>
          </div>
          
        </div>
        
      </div>
      <div class='container'>
        <h2>Introduction</h2>
        
        <p>This page acts as a quick summary for <a href="/documentation/ByteCode2OpenCL.pdf" rel="nofollow">the more detailed PDF</a> that was originally written by AMD.</p>
        
        <p>One of the unique Aparapi features is it&rsquo;s ability to convert Java bytecode to OpenCL automatically.</p>
        
        <p>In this page we will try to describe the process used to perform this conversion. If you are unfamiliar with bytecode consider visiting this page WhatIsBytecode.</p>
        
        <p>The command</p>
        <pre class="highlight java"><code>
        <span class="n">javac</span> <span class="n">Source</span><span class="o">.</span><span class="na">java</span>
        </code></pre>
        <p>Will compile the java source file Source.java to Source.class</p>
        
        <p>The classfile format is well documented here and we will not go into too much detail here, however it should be known that Aparapi must parse the classfile of each Kernel to extract the bytecode for the <code>Kernel.run()</code> and any method reachable from <code>Kernel.run()</code>.</p>
        
        <p>Lets start with a simple Kernel.</p>
        <pre class="highlight java"><code>
        <span class="kn">import</span> <span class="nn">com.aparapi.Kernel</span><span class="o">;</span>
        
        <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Squarer</span> <span class="kd">extends</span> <span class="n">Kernel</span><span class="o">{</span>
           <span class="kt">int</span><span class="o">[]</span> <span class="n">in</span><span class="o">;</span>
           <span class="kt">int</span><span class="o">[]</span> <span class="n">out</span><span class="o">;</span>
           <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(){</span>
              <span class="kt">int</span> <span class="n">gid</span> <span class="o">=</span> <span class="n">getGlobalId</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
              <span class="n">out</span><span class="o">[</span><span class="n">gid</span><span class="o">]</span> <span class="o">=</span> <span class="n">in</span><span class="o">[</span><span class="n">gid</span><span class="o">]</span> <span class="o">*</span> <span class="n">in</span><span class="o">[</span><span class="n">gid</span><span class="o">];</span>
           <span class="o">}</span>
        <span class="o">}</span>
        </code></pre>
        <p>We will compile this</p>
        <pre class="highlight java"><code>
        <span class="n">javac</span> <span class="o">-</span><span class="n">g</span> <span class="o">-</span><span class="n">cp</span> <span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">aparapi</span><span class="o">/</span><span class="n">aparapi</span><span class="o">.</span><span class="na">jar</span> <span class="n">Squarer</span><span class="o">.</span><span class="na">java</span>
        </code></pre>
        <p>and then we can look at the bytecode using javap</p>
        <pre class="highlight java"><code>
        <span class="n">javap</span> <span class="o">-</span><span class="n">c</span> <span class="o">-</span><span class="n">classpath</span> <span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">aparapi</span><span class="o">/</span><span class="n">aparapi</span><span class="o">.</span><span class="na">jar</span><span class="o">;.</span> <span class="n">Squarer</span>
        </code></pre>
        <p>Compiled from &ldquo;Squarer.java&rdquo;</p>
        <pre class="highlight java"><code>
        <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Squarer</span> <span class="kd">extends</span> <span class="n">com</span><span class="o">.</span><span class="na">aparapi</span><span class="o">.</span><span class="na">Kernel</span>
          <span class="nl">SourceFile:</span> <span class="s">"Squarer.java"</span>
          <span class="n">minor</span> <span class="nl">version:</span> <span class="mi">0</span>
          <span class="n">major</span> <span class="nl">version:</span> <span class="mi">50</span>
          <span class="n">Constant</span> <span class="nl">pool:</span>
        <span class="kd">const</span> <span class="err">#</span><span class="mi">1</span> <span class="o">=</span> <span class="n">Method</span>       <span class="err">#</span><span class="mi">6</span><span class="o">.</span><span class="err">#</span><span class="mi">17</span><span class="o">;</span> <span class="c1">//  com/amd/aparapi/Kernel."&lt;init&gt;":()V</span>
        <span class="kd">const</span> <span class="err">#</span><span class="mi">2</span> <span class="o">=</span> <span class="n">Method</span>       <span class="err">#</span><span class="mi">5</span><span class="o">.</span><span class="err">#</span><span class="mi">18</span><span class="o">;</span> <span class="c1">//  Squarer.getGlobalId:(I)I</span>
        <span class="kd">const</span> <span class="err">#</span><span class="mi">3</span> <span class="o">=</span> <span class="n">Field</span>        <span class="err">#</span><span class="mi">5</span><span class="o">.</span><span class="err">#</span><span class="mi">19</span><span class="o">;</span> <span class="c1">//  Squarer.out:[I</span>
        <span class="kd">const</span> <span class="err">#</span><span class="mi">4</span> <span class="o">=</span> <span class="n">Field</span>        <span class="err">#</span><span class="mi">5</span><span class="o">.</span><span class="err">#</span><span class="mi">20</span><span class="o">;</span> <span class="c1">//  Squarer.in:[I</span>
        <span class="kd">const</span> <span class="err">#</span><span class="mi">5</span> <span class="o">=</span> <span class="kd">class</span>        <span class="err">#21;</span>    <span class="err">//</span>  <span class="nc">Squarer</span>
        <span class="kd">const</span> <span class="err">#</span><span class="mi">6</span> <span class="o">=</span> <span class="kd">class</span>        <span class="err">#22;</span>    <span class="err">//</span>  <span class="nc">com</span><span class="o">/</span><span class="n">amd</span><span class="o">/</span><span class="n">aparapi</span><span class="o">/</span><span class="n">Kernel</span>
        <span class="kd">const</span> <span class="err">#</span><span class="mi">7</span> <span class="o">=</span> <span class="n">Asciz</span>        <span class="n">in</span><span class="o">;</span>
        <span class="kd">const</span> <span class="err">#</span><span class="mi">8</span> <span class="o">=</span> <span class="n">Asciz</span>        <span class="o">[</span><span class="n">I</span><span class="o">;</span>
        <span class="kd">const</span> <span class="err">#</span><span class="mi">9</span> <span class="o">=</span> <span class="n">Asciz</span>        <span class="n">out</span><span class="o">;</span>
        <span class="kd">const</span> <span class="err">#</span><span class="mi">10</span> <span class="o">=</span> <span class="n">Asciz</span>       <span class="o">&lt;</span><span class="n">init</span><span class="o">&gt;;</span>
        <span class="kd">const</span> <span class="err">#</span><span class="mi">11</span> <span class="o">=</span> <span class="n">Asciz</span>       <span class="o">()</span><span class="n">V</span><span class="o">;</span>
        <span class="kd">const</span> <span class="err">#</span><span class="mi">12</span> <span class="o">=</span> <span class="n">Asciz</span>       <span class="n">Code</span><span class="o">;</span>
        <span class="kd">const</span> <span class="err">#</span><span class="mi">13</span> <span class="o">=</span> <span class="n">Asciz</span>       <span class="n">LineNumberTable</span><span class="o">;</span>
        <span class="kd">const</span> <span class="err">#</span><span class="mi">14</span> <span class="o">=</span> <span class="n">Asciz</span>       <span class="n">run</span><span class="o">;</span>
        <span class="kd">const</span> <span class="err">#</span><span class="mi">15</span> <span class="o">=</span> <span class="n">Asciz</span>       <span class="n">SourceFile</span><span class="o">;</span>
        <span class="kd">const</span> <span class="err">#</span><span class="mi">16</span> <span class="o">=</span> <span class="n">Asciz</span>       <span class="n">Squarer</span><span class="o">.</span><span class="na">java</span><span class="o">;</span>
        <span class="kd">const</span> <span class="err">#</span><span class="mi">17</span> <span class="o">=</span> <span class="n">NameAndType</span> <span class="err">#</span><span class="mi">10</span><span class="o">:</span><span class="err">#</span><span class="mi">11</span><span class="o">;</span><span class="c1">//  "&lt;init&gt;":()V</span>
        <span class="kd">const</span> <span class="err">#</span><span class="mi">18</span> <span class="o">=</span> <span class="n">NameAndType</span> <span class="err">#</span><span class="mi">23</span><span class="o">:</span><span class="err">#</span><span class="mi">24</span><span class="o">;</span><span class="c1">//  getGlobalId:(I)I</span>
        <span class="kd">const</span> <span class="err">#</span><span class="mi">19</span> <span class="o">=</span> <span class="n">NameAndType</span> <span class="err">#</span><span class="mi">9</span><span class="o">:</span><span class="err">#</span><span class="mi">8</span><span class="o">;</span><span class="c1">//  out:[I</span>
        <span class="kd">const</span> <span class="err">#</span><span class="mi">20</span> <span class="o">=</span> <span class="n">NameAndType</span> <span class="err">#</span><span class="mi">7</span><span class="o">:</span><span class="err">#</span><span class="mi">8</span><span class="o">;</span><span class="c1">//  in:[I</span>
        <span class="kd">const</span> <span class="err">#</span><span class="mi">21</span> <span class="o">=</span> <span class="n">Asciz</span>       <span class="n">Squarer</span><span class="o">;</span>
        <span class="kd">const</span> <span class="err">#</span><span class="mi">22</span> <span class="o">=</span> <span class="n">Asciz</span>       <span class="n">com</span><span class="o">/</span><span class="n">amd</span><span class="o">/</span><span class="n">aparapi</span><span class="o">/</span><span class="n">Kernel</span><span class="o">;</span>
        <span class="kd">const</span> <span class="err">#</span><span class="mi">23</span> <span class="o">=</span> <span class="n">Asciz</span>       <span class="n">getGlobalId</span><span class="o">;</span>
        <span class="kd">const</span> <span class="err">#</span><span class="mi">24</span> <span class="o">=</span> <span class="n">Asciz</span>       <span class="o">(</span><span class="n">I</span><span class="o">)</span><span class="n">I</span><span class="o">;</span>
        
        <span class="o">{</span>
        <span class="kt">int</span><span class="o">[]</span> <span class="n">in</span><span class="o">;</span>
        
        <span class="kt">int</span><span class="o">[]</span> <span class="n">out</span><span class="o">;</span>
        
        <span class="kd">public</span> <span class="nf">Squarer</span><span class="o">();</span>
          <span class="nl">Code:</span>
           <span class="n">Stack</span><span class="o">=</span><span class="mi">1</span><span class="o">,</span> <span class="n">Locals</span><span class="o">=</span><span class="mi">1</span><span class="o">,</span> <span class="n">Args_size</span><span class="o">=</span><span class="mi">1</span>
           <span class="mi">0</span><span class="o">:</span>   <span class="n">aload_0</span>
           <span class="mi">1</span><span class="o">:</span>   <span class="n">invokespecial</span>   <span class="err">#</span><span class="mi">1</span><span class="o">;</span> <span class="c1">//Method com/amd/aparapi/Kernel."&lt;init&gt;":()V</span>
           <span class="mi">4</span><span class="o">:</span>   <span class="k">return</span>
        
        
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">();</span>
          <span class="nl">Code:</span>
           <span class="n">Stack</span><span class="o">=</span><span class="mi">5</span><span class="o">,</span> <span class="n">Locals</span><span class="o">=</span><span class="mi">2</span><span class="o">,</span> <span class="n">Args_size</span><span class="o">=</span><span class="mi">1</span>
           <span class="mi">0</span><span class="o">:</span>   <span class="n">aload_0</span>
           <span class="mi">1</span><span class="o">:</span>   <span class="n">iconst_0</span>
           <span class="mi">2</span><span class="o">:</span>   <span class="n">invokevirtual</span>   <span class="err">#</span><span class="mi">2</span><span class="o">;</span> <span class="c1">//Method getGlobalId:(I)I</span>
           <span class="mi">5</span><span class="o">:</span>   <span class="n">istore_1</span>
           <span class="mi">6</span><span class="o">:</span>   <span class="n">aload_0</span>
           <span class="mi">7</span><span class="o">:</span>   <span class="n">getfield</span>        <span class="err">#</span><span class="mi">3</span><span class="o">;</span> <span class="c1">//Field out:[I</span>
           <span class="mi">10</span><span class="o">:</span>  <span class="n">iload_1</span>
           <span class="mi">11</span><span class="o">:</span>  <span class="n">aload_0</span>
           <span class="mi">12</span><span class="o">:</span>  <span class="n">getfield</span>        <span class="err">#</span><span class="mi">4</span><span class="o">;</span> <span class="c1">//Field in:[I</span>
           <span class="mi">15</span><span class="o">:</span>  <span class="n">iload_1</span>
           <span class="mi">16</span><span class="o">:</span>  <span class="n">iaload</span>
           <span class="mi">17</span><span class="o">:</span>  <span class="n">aload_0</span>
           <span class="mi">18</span><span class="o">:</span>  <span class="n">getfield</span>        <span class="err">#</span><span class="mi">4</span><span class="o">;</span> <span class="c1">//Field in:[I</span>
           <span class="mi">21</span><span class="o">:</span>  <span class="n">iload_1</span>
           <span class="mi">22</span><span class="o">:</span>  <span class="n">iaload</span>
           <span class="mi">23</span><span class="o">:</span>  <span class="n">imul</span>
           <span class="mi">24</span><span class="o">:</span>  <span class="n">iastore</span>
           <span class="mi">25</span><span class="o">:</span>  <span class="k">return</span>
        <span class="o">}</span>
        </code></pre>
        <p>Here we see constant pool of the class and the disassembled bytecode of the default constructor <code>Squarer()</code> and the <code>Squarer.run()</code> method.</p>
        
        <p>The constant pool is a table of constant values that can be accessed from the bytecode of any methods from within this class. Some of the constants are String literals defined within the source (or literals used to name classes, fields, methods, variables or signatures), other slots represent Classes, Methods, Fields or Type signatures. These later constant pool entries cross-reference other constant pool entries to describe higher level artifact.</p>
        
        <p>For example constant pool entry #1 is</p>
        <pre class="highlight java"><code>
        <span class="kd">const</span> <span class="err">#</span><span class="mi">1</span> <span class="o">=</span> <span class="n">Method</span>       <span class="err">#</span><span class="mi">6</span><span class="o">.</span><span class="err">#</span><span class="mi">17</span><span class="o">;</span> <span class="c1">//  com/amd/aparapi/Kernel."&lt;init&gt;":()V</span>
        </code></pre>
        <p>So entry #1 defines a method. The class containing the method is defined in constant pool entry #6. So lets look at constant pool entry #6.</p>
        <pre class="highlight java"><code>
        <span class="kd">const</span> <span class="err">#</span><span class="mi">1</span> <span class="o">=</span> <span class="n">Method</span>       <span class="err">#</span><span class="mi">6</span><span class="o">.</span><span class="err">#</span><span class="mi">17</span><span class="o">;</span> <span class="c1">//  com/amd/aparapi/Kernel."&lt;init&gt;":()V</span>
        
        <span class="kd">const</span> <span class="err">#</span><span class="mi">6</span> <span class="o">=</span> <span class="kd">class</span>        <span class="err">#22;</span>    <span class="err">//</span>  <span class="nc">com</span><span class="o">/</span><span class="n">amd</span><span class="o">/</span><span class="n">aparapi</span><span class="o">/</span><span class="n">Kernel</span>
        </code></pre>
        <p>At constant pool entry #6 we find a class definition which refers to entry #22</p>
        <pre class="highlight java"><code>
        <span class="kd">const</span> <span class="err">#</span><span class="mi">1</span> <span class="o">=</span> <span class="n">Method</span>       <span class="err">#</span><span class="mi">6</span><span class="o">.</span><span class="err">#</span><span class="mi">17</span><span class="o">;</span> <span class="c1">//  com/amd/aparapi/Kernel."&lt;init&gt;":()V</span>
        
        <span class="kd">const</span> <span class="err">#</span><span class="mi">6</span> <span class="o">=</span> <span class="kd">class</span>        <span class="err">#22;</span>    <span class="err">//</span>  <span class="nc">com</span><span class="o">/</span><span class="n">amd</span><span class="o">/</span><span class="n">aparapi</span><span class="o">/</span><span class="n">Kernel</span>
        
        <span class="kd">const</span> <span class="err">#</span><span class="mi">22</span> <span class="o">=</span> <span class="n">Asciz</span>       <span class="n">com</span><span class="o">/</span><span class="n">amd</span><span class="o">/</span><span class="n">aparapi</span><span class="o">/</span><span class="n">Kernel</span><span class="o">;</span>
        </code></pre>
        <p>Which just contains the String (Ascii) name of the class.</p>
        
        <p>Looking back at entry #1 again, we note that the Method also references entry #17 which contains a NameAndType entry for determining the method name and the signature.</p>
        <pre class="highlight java"><code>
        <span class="kd">const</span> <span class="err">#</span><span class="mi">1</span> <span class="o">=</span> <span class="n">Method</span>       <span class="err">#</span><span class="mi">6</span><span class="o">.</span><span class="err">#</span><span class="mi">17</span><span class="o">;</span> <span class="c1">//  com/amd/aparapi/Kernel."&lt;init&gt;":()V</span>
        
        <span class="kd">const</span> <span class="err">#</span><span class="mi">6</span> <span class="o">=</span> <span class="kd">class</span>        <span class="err">#22;</span>    <span class="err">//</span>  <span class="nc">com</span><span class="o">/</span><span class="n">amd</span><span class="o">/</span><span class="n">aparapi</span><span class="o">/</span><span class="n">Kernel</span>
        
        
        <span class="kd">const</span> <span class="err">#</span><span class="mi">17</span> <span class="o">=</span> <span class="n">NameAndType</span> <span class="err">#</span><span class="mi">10</span><span class="o">:</span><span class="err">#</span><span class="mi">11</span><span class="o">;</span><span class="c1">//  "&lt;init&gt;":()V</span>
        
        <span class="kd">const</span> <span class="err">#</span><span class="mi">22</span> <span class="o">=</span> <span class="n">Asciz</span>       <span class="n">com</span><span class="o">/</span><span class="n">amd</span><span class="o">/</span><span class="n">aparapi</span><span class="o">/</span><span class="n">Kernel</span><span class="o">;</span>
        </code></pre>
        <p>Entry #17&rsquo;s &ldquo;NameAndType&rdquo; references #10 for the method name.</p>
        <pre class="highlight java"><code>
        <span class="kd">const</span> <span class="err">#</span><span class="mi">1</span> <span class="o">=</span> <span class="n">Method</span>       <span class="err">#</span><span class="mi">6</span><span class="o">.</span><span class="err">#</span><span class="mi">17</span><span class="o">;</span> <span class="c1">//  com/amd/aparapi/Kernel."&lt;init&gt;":()V</span>
        
        <span class="kd">const</span> <span class="err">#</span><span class="mi">6</span> <span class="o">=</span> <span class="kd">class</span>        <span class="err">#22;</span>    <span class="err">//</span>  <span class="nc">com</span><span class="o">/</span><span class="n">amd</span><span class="o">/</span><span class="n">aparapi</span><span class="o">/</span><span class="n">Kernel</span>
        
        <span class="kd">const</span> <span class="err">#</span><span class="mi">10</span> <span class="o">=</span> <span class="n">Asciz</span>       <span class="o">&lt;</span><span class="n">init</span><span class="o">&gt;;</span>
        
        <span class="kd">const</span> <span class="err">#</span><span class="mi">17</span> <span class="o">=</span> <span class="n">NameAndType</span> <span class="err">#</span><span class="mi">10</span><span class="o">:</span><span class="err">#</span><span class="mi">11</span><span class="o">;</span><span class="c1">//  "&lt;init&gt;":()V</span>
        
        <span class="kd">const</span> <span class="err">#</span><span class="mi">22</span> <span class="o">=</span> <span class="n">Asciz</span>       <span class="n">com</span><span class="o">/</span><span class="n">amd</span><span class="o">/</span><span class="n">aparapi</span><span class="o">/</span><span class="n">Kernel</span><span class="o">;</span>
        </code></pre>
        <p>And then references #11 to get the signature.</p>
        <pre class="highlight java"><code>
        <span class="kd">const</span> <span class="err">#</span><span class="mi">1</span> <span class="o">=</span> <span class="n">Method</span>       <span class="err">#</span><span class="mi">6</span><span class="o">.</span><span class="err">#</span><span class="mi">17</span><span class="o">;</span> <span class="c1">//  com/amd/aparapi/Kernel."&lt;init&gt;":()V</span>
        
        <span class="kd">const</span> <span class="err">#</span><span class="mi">6</span> <span class="o">=</span> <span class="kd">class</span>        <span class="err">#22;</span>    <span class="err">//</span>  <span class="nc">com</span><span class="o">/</span><span class="n">amd</span><span class="o">/</span><span class="n">aparapi</span><span class="o">/</span><span class="n">Kernel</span>
        
        <span class="kd">const</span> <span class="err">#</span><span class="mi">10</span> <span class="o">=</span> <span class="n">Asciz</span>       <span class="o">&lt;</span><span class="n">init</span><span class="o">&gt;;</span>
        
        <span class="kd">const</span> <span class="err">#</span><span class="mi">11</span> <span class="o">=</span> <span class="n">Asciz</span>       <span class="o">()</span><span class="n">V</span><span class="o">;</span>
        
        <span class="kd">const</span> <span class="err">#</span><span class="mi">17</span> <span class="o">=</span> <span class="n">NameAndType</span> <span class="err">#</span><span class="mi">10</span><span class="o">:</span><span class="err">#</span><span class="mi">11</span><span class="o">;</span><span class="c1">//  "&lt;init&gt;":()V</span>
        
        <span class="kd">const</span> <span class="err">#</span><span class="mi">22</span> <span class="o">=</span> <span class="n">Asciz</span>       <span class="n">com</span><span class="o">/</span><span class="n">amd</span><span class="o">/</span><span class="n">aparapi</span><span class="o">/</span><span class="n">Kernel</span><span class="o">;</span>
        </code></pre>
        <p>So from constant pool #1 we ended up using slots 1,6,10,11,17 and 22 to fully resolve the method.</p>
        
        <p>This looks like a lot of work, however by breaking method and field references up like this, allows the various slots to be reused by other field/method descriptions.</p>
        
        <p>So when we see disassembled bytecode which references a constantpool slot the actual slot # (2 in the example below) will appear after the bytecode for invokevirtual.</p>
        <pre class="highlight java"><code>
        <span class="mi">2</span><span class="o">:</span>   <span class="n">invokevirtual</span>   <span class="err">#</span><span class="mi">2</span><span class="o">;</span> <span class="n">Method</span> <span class="nl">getGlobalId:</span><span class="o">(</span><span class="n">I</span><span class="o">)</span><span class="n">I</span>
        </code></pre>
        <p>Bytecode is basically able to access three things</p>
        
        <ol>
        <li>Constant pool entries</li>
        <li>Variable slots</li>
        <li>Stack operands</li>
        </ol>
        
        <p>Instructions are able to pop operands from the stack, push operands to the stack, load values from variable slots (to the stack), store values (from the stack) to variable slots, store values from accessed fields (to the stack) and call methods (popping args from the stack).</p>
        
        <p>Some instructions can only handle specific types (int, float, double, and object instances - arrays are special forms of objects) and usually the first character of the instruction helps determine which type the instruction acts upon. So imul would be a multiply instruction that operates on integers, fmul would multiply two floats, dmul for doubles. Instructions that begin with &lsquo;a&rsquo; operate on object instances.</p>
        
        <p>So lets look at the first instruction.</p>
        <pre class="highlight java"><code>
        <span class="mi">0</span><span class="o">:</span>   <span class="n">aload_0</span>
        </code></pre>
        <p>This instruction loads an object (a is the first character) from variable slot 0 (we&rsquo;ll come back to the variable slots in a moment) and pushes it on the stack.</p>
        
        <p>Variables are held in &#39;slots&rsquo; that are reserved at compiled time.</p>
        
        <p>Consider this static method.</p>
        <pre class="highlight java"><code>
        <span class="kd">static</span> <span class="kt">int</span> <span class="nf">squareMe</span><span class="o">(</span><span class="kt">int</span> <span class="n">value</span><span class="o">){</span>
          <span class="n">value</span> <span class="o">+=</span> <span class="n">value</span><span class="o">;</span>
          <span class="k">return</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
        <span class="o">}</span>
        </code></pre>
        <p>This method requires one variable slot. At any one time there is only one variable that is live, it just happens to be an argument to the method.</p>
        
        <p>The following method also contains one slot.</p>
        <pre class="highlight java"><code>
        <span class="kd">static</span> <span class="kt">int</span> <span class="nf">squareMe</span><span class="o">(){</span>
          <span class="kt">int</span> <span class="n">value</span><span class="o">=</span><span class="mi">4</span><span class="o">;</span>
          <span class="n">value</span> <span class="o">+=</span> <span class="n">value</span><span class="o">;</span>
          <span class="k">return</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
        <span class="o">}</span>
        </code></pre>
        <p>Here we need two slots</p>
        <pre class="highlight java"><code>
        <span class="kd">static</span> <span class="kt">int</span> <span class="nf">squareMe</span><span class="o">(</span><span class="kt">int</span> <span class="n">arg</span><span class="o">){</span>
          <span class="kt">int</span> <span class="n">value</span><span class="o">=</span><span class="n">arg</span><span class="o">*</span><span class="n">arg</span><span class="o">;</span>
          <span class="k">return</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
        <span class="o">}</span>
        </code></pre>
        <p>Suprisingly the following also only requires two slots.</p>
        <pre class="highlight plaintext"><code>static int squareMe(int arg){
          {
            int temp = arg*arg;
          }
          int value=arg*arg;
          return(value);
        }
        </code></pre>
        <p>Note that in the above example the temp variable loses scope before the local variable value is used. So only two slots are required. Both temp and value can share a slot.</p>
        
        <p>If we have an instance method we always require one extra slot (always slot 0) for the this reference.</p>
        
        <p>So</p>
        <pre class="highlight java"><code>
        <span class="kt">int</span> <span class="nf">squareMe</span><span class="o">(</span><span class="kt">int</span> <span class="n">arg</span><span class="o">){</span>
          <span class="kt">int</span> <span class="n">value</span><span class="o">=</span><span class="n">arg</span><span class="o">*</span><span class="n">arg</span><span class="o">;</span>
          <span class="k">return</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
        <span class="o">}</span>
        </code></pre>
        <p>Requires three slots.</p>
        
        <p>Anyway back to our bytecode</p>
        <pre class="highlight java"><code>
        <span class="mi">0</span><span class="o">:</span>   <span class="n">aload_0</span>
        </code></pre>
        <p>This loads the object instance in slot 0 (this) and pushes it on the stack.</p>
        
        <p>Next we have</p>
        <pre class="highlight java"><code>
        <span class="mi">1</span><span class="o">:</span>   <span class="n">iconst_0</span>
        </code></pre>
        <p>Which pushes the int constant 0 on the stack. So the stack contains {this,0}</p>
        
        <p>Next we have</p>
        <pre class="highlight java"><code>
        <span class="mi">2</span><span class="o">:</span>   <span class="n">invokevirtual</span>   <span class="err">#</span><span class="mi">2</span><span class="o">;</span> <span class="c1">//Method getGlobalId:(I)I</span>
        </code></pre>
        <p>This is the bytecode for calling a method. Basically the instruction itself references the constant pool (we&rsquo;ll come back to this ;) ) and pulls the method description in <code>constantPool2</code> which happens to be the description for a method called <code>getGlobalId()</code> which takes an integer and returns an <code>int</code>.</p>
        
        <p>So the VM will pop the top value <code>(int - const 0)</code> as the method arg, and then will pop an object reference (this!) and will call the method <code>this.getGlobalId(0)</code> and will push the result (an int) back on the stack.</p>
        
        <p>So our stack which contains <code>{this,0}</code> now contains the result of this.getGlobalId(0), lets assume it is <code>{0}</code>. We describe this invoke instruction as consuming two operands from the stack and producing one.</p>
        
        <p>Before we start executing our stack is empty {}, the slots are initialized with &#39;this&rsquo; (if an instance method) and any arguments passed to the method.</p>
        <pre class="highlight java"><code>
                                                                    <span class="mi">0</span>   <span class="mi">1</span>
                                                           <span class="n">slots</span><span class="o">=[</span><span class="k">this</span><span class="o">,</span> <span class="o">?</span>  <span class="o">]</span>    <span class="n">stack</span><span class="o">={}</span>
        
                                                                    <span class="mi">0</span>   <span class="mi">1</span>
        <span class="mi">0</span><span class="o">:</span>   <span class="n">aload_0</span>                                        <span class="n">slots</span><span class="o">=[</span><span class="k">this</span><span class="o">,</span> <span class="o">?</span>  <span class="o">]</span>    <span class="n">stack</span><span class="o">={</span><span class="k">this</span><span class="o">}</span>
                                                                    <span class="mi">0</span>   <span class="mi">1</span>
        <span class="mi">1</span><span class="o">:</span>   <span class="n">iconst_0</span>                                       <span class="n">slots</span><span class="o">=[</span><span class="k">this</span><span class="o">,</span> <span class="o">?</span>  <span class="o">]</span>    <span class="n">stack</span><span class="o">={</span><span class="k">this</span><span class="o">,</span> <span class="mi">0</span><span class="o">}</span>
                                                                    <span class="mi">0</span>   <span class="mi">1</span>
        <span class="mi">2</span><span class="o">:</span>   <span class="n">invokevirtual</span>   <span class="err">#</span><span class="mi">2</span><span class="o">;</span> <span class="n">Method</span> <span class="nl">getGlobalId:</span><span class="o">(</span><span class="n">I</span><span class="o">)</span><span class="n">I</span>    <span class="n">slots</span><span class="o">=[</span><span class="k">this</span><span class="o">,</span> <span class="o">?</span>  <span class="o">]</span>  <span class="n">stack</span><span class="o">={</span><span class="n">result</span> <span class="n">of</span> <span class="k">this</span><span class="o">.</span><span class="na">getGlobalId</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="n">lets</span> <span class="n">say</span> <span class="mi">0</span><span class="o">}</span>
        
        <span class="mi">5</span><span class="o">:</span>   <span class="n">istore_1</span>                                       <span class="n">slots</span><span class="o">=[</span><span class="k">this</span><span class="o">,</span> <span class="mi">0</span>  <span class="o">]</span>    <span class="n">stack</span><span class="o">={}</span>
        
        <span class="mi">6</span><span class="o">:</span>   <span class="n">aload_0</span>                                        <span class="n">slots</span><span class="o">=[</span><span class="k">this</span><span class="o">,</span> <span class="mi">0</span>  <span class="o">]</span>    <span class="n">stack</span><span class="o">={</span><span class="k">this</span><span class="o">}</span>
        
        <span class="mi">7</span><span class="o">:</span>   <span class="n">getfield</span>        <span class="err">#</span><span class="mi">3</span><span class="o">;</span> <span class="c1">//Field out:[I</span>
        </code></pre>
      </div>
    </main>
    <footer class='page-footer'>
      <div class='container'>
        <div class='row'>
          <div class='col l4 s12'>
            <h5 class='white-text'>Help Aparapi Grow</h5>
            <p class='grey-text text-lighten-4'>We are a team of volunteers working on this project like it's our full time job. Any amount would help support and continue development on this project and is greatly appreciated.</p>
            <form action='https://www.paypal.com/cgi-bin/webscr' id='paypal-donate' method='post' target='_top'>
              <input name='cmd' type='hidden' value='_s-xclick'>
              <input name='encrypted' type='hidden' value='-----BEGIN PKCS7-----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-----END PKCS7-----'>
              <button alt='PayPal - The safer, easier way to pay online!' class='btn waves-effect waves-light red lighten-3' name='action' type='submit'>
                Donate Now
              </button>
            </form>
          </div>
          <div class='col l4 s12'>
            <h5 class='white-text'>Join the Discussion</h5>
            <p class='grey-text text-lighten-4'>We have a Gitter chat room set up where you can talk directly with us. Come in and discuss new features, future goals, general problems or questions, or anything else you can think of.</p>
            <a class='btn waves-effect waves-light red lighten-3' href='https://gitter.im/Syncleus/aparapi' target='_blank'>Chat</a>
          </div>
          <div class='col l4 s12' style='overflow: hidden;'>
            <h5 class='white-text'>Connect</h5>
            <iframe allowtransparency='true' frameborder='0' height='30' scrolling='0' src='http://ghbtns.com/github-btn.html?user=Syncleus&amp;repo=aparapi&amp;type=watch&amp;count=true&amp;size=large' width='170'></iframe>
            <br>
            <a class='twitter-follow-button' data-dnt='true' data-show-count='true' data-size='large' href='https://twitter.com/AparapiLib'>Follow @AparapiLib</a>
            <br>
            <div class='g-follow' data-annotation='bubble' data-height='24' data-href='https://plus.google.com/102266131584900704956' data-rel='publisher'></div>
          </div>
        </div>
      </div>
      <div class='footer-copyright'>
        <div class='container'>
          Â© 2016-2017 Syncleus, All rights reserved.
          <a class='grey-text text-lighten-4 right' href='https://github.com/Syncleus/aparapi/blob/master/LICENSE'>Apache License v2</a>
        </div>
      </div>
    </footer>
    <!-- Scripts -->
    <script src='https://code.jquery.com/jquery-2.1.4.min.js'></script>
    <script>
      if (!window.jQuery) { document.write('<script src="bin/jquery-2.1.1.min.js"><\/script>'); }
    </script>
    <script src='/javascripts/jquery.timeago.js'></script>
    <script src='/javascripts/materialize.min.js'></script>
    <script src='/javascripts/lunr.min.js'></script>
    <script src='/javascripts/search.js'></script>
    <script src='/javascripts/materialize.js'></script>
    <script src='/javascripts/init.js'></script>
    <!-- Twitter Button -->
    <script>
      !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');
    </script>
    <!-- Google Plus Button -->
    <script async='' defer='defer' src='https://apis.google.com/js/platform.js'></script>
  </body>
</html>
