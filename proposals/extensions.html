<!DOCTYPE html>
<html lang='en'>
  <head>
    <meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
    <meta content='width=device-width, initial-scale=1' name='viewport'>
    <meta content='IE=edge' http-equiv='X-UA-Compatible'>
    <meta content='no' name='msapplication-tap-highlight'>
    <meta content='Aparapi is an Open-source framework for executing native Java code on the GPU, developed by Syncleus.' name='description'>
    <title>
      Aparapi | Extensions
    </title>
    <!-- Favicons -->
    <link href='/images/favicon/apple-touch-icon-152x152.png' rel='apple-touch-icon-precomposed'>
    <meta content='#FFFFFF' name='msapplication-TileColor'>
    <meta content='/images/favicon/mstile-144x144.png' name='msapplication-TileImage'>
    <link href='/images/favicon/favicon-32x32.png' rel='icon' sizes='32x32'>
    <!-- Android 5 Chrome Color -->
    <meta content='#EE6E73' name='theme-color'>
    <!-- CSS -->
    <link href='/stylesheets/highlight.css' media='screen,projection' rel='stylesheet' type='text/css'>
    <link href='/stylesheets/style.css' media='screen,projection' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/icon?family=Material+Icons' rel='stylesheet'>
  </head>
  <body>
    <header>
      <div class='container'>
        <a class='button-collapse top-nav waves-effect waves-light circle hide-on-large-only' data-activates='nav-mobile' href='#'>
          <i class='material-icons'>menu</i>
        </a>
      </div>
      <ul class='side-nav fixed' id='nav-mobile'>
        <li class='logo'>
          <a class='brand-logo' href='/' id='logo-container'>
            <object data='/images/logo.svg' id='front-page-logo' type='image/svg+xml'>Your browser does not support SVG</object>
          </a>
        </li>
        <li class='search'>
          <div class='search-wrapper card'>
            <input id='search'>
            <i class='material-icons'>search</i>
            <div class='search-results'></div>
          </div>
        </li>
        <li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/">Overview</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a class='collapsible-header waves-effect waves-teal'>Introduction</a><div class='collapsible-body'><ul><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/introduction/about.html">About</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/introduction/getting-started.html">Getting Started</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/introduction/faq.html">FAQ</a></li></ul></li></ul></div></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a class='collapsible-header waves-effect waves-teal'>Documentation</a><div class='collapsible-body'><ul><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/aparapi-patterns.html">Aparapi Patterns</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/choosing-specific-devices.html">Choosing Specific Devices</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/converting-java-to-opencl.html">Converting Java to OpenCL</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/emulating-multiple-entrypoints.html">Emulating Multiple Entrypoints</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/explicit-buffer-handling.html">ExplicitBufferHandling</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/hsa-enabled-lambda.html">HSA Enabled Lambda</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/kernel-guidelines.html">Kernel Guidelines</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/library-agent-duality.html">Library Agent Duality</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/new-features.html">New Features</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/opencl-bindings.html">OpenCL Bindings</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/private-memory-space.html">Private Memory Space</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/profiling-the-kernel.html">Profiling the Kernel</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/setting-up-hsa.html">Setting Up HSA</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/unit-tests.html">Unit Tests</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/using-hsa-simulator.html">Using HSA Simulator</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/constant-memory.html">Constant Memory</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/local-memory.html">Local Memory</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/multiple-dim-ranges.html">Multiple Dim Ranges</a></li></ul></li></ul></div></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a class='collapsible-header waves-effect waves-teal'>Proposals</a><div class='collapsible-body'><ul><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/proposals/multiple-dim-nd-range.html">Multiple Dim ND Range</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/proposals/lambdas.html">Lambdas</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/proposals/address-space-with-buffers.html">Address Space with Buffers</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/proposals/extensions.html">Extensions</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/proposals/device.html">Device</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/proposals/multiple-entry-points.html">Multiple Entry Points</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/proposals/lambda-syntax.html">Lambda Syntax</a></li></ul></li></ul></div></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/showcase.html">Showcase</a></li></ul></li>
      </ul>
    </header>
    <main>
      <div class='section no-pad-bot' id='index-banner'>
        <div class='container'>
          <h1 class='header center-on-small-only'>Extensions</h1>
          <div class='row center'>
            <h4 class='header col s12 light center'>A proposed aparapi extension mechanism.</h4>
          </div>
          
        </div>
        
      </div>
      <div class='container'>
        <h2>Here is a proposed Aparapi extension mechanism</h2>
        
        <p>This would allow a developer to create a library that could be used by Aparapi Kernel code. The library would include OpenCL and Java implementations.</p>
        
        <p>We will treat this as a live document. Please join the discussions at http://groups.google.com/group/aparapi-discuss/browse_thread/thread/7ec81ecb2169aa4 and I will update this page to reflect what I think the latest decisions are:-</p>
        
        <p>Currently Aparapi allows Java bytecode to be converted to OpenCL at runtime. Only the OpenCL generated by this conversion process is made available. Sometimes for performance reasons we might want to allow hand coded OpenCL to be called from Aparapi kernel code.</p>
        
        <p>Here we will present a strawman API which would allow extension points to be added by an end user or by a library provider.</p>
        
        <p>We will use an FFT usecase to walk through the steps.</p>
        
        <p>The FFT (Fast Fourier Transform) algorithm can be coded in Aparapi, but for performance reasons handcrafted OpenCL is likely to be more performant. The goal is to allow Aparapi to do what it does best, i.e. manage the host buffer allocations and provide a mechanism for binding arbitrary opencl code at runtime.</p>
        
        <p>So lets assume we wanted an Aparapi Kernel to be able to call an Aparapi extension for computing FFT (forward and reverse). The Kernel implementation might look like this.</p>
        <pre class="highlight java"><code>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">BandStopFilter</span> <span class="kd">extends</span> <span class="n">Kernel</span><span class="o">{</span>
           <span class="n">FFT</span> <span class="n">fft</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FFT</span><span class="o">();</span> <span class="c1">// Create an instance of the Extension point.</span>
           <span class="kt">float</span><span class="o">[]</span> <span class="n">real</span><span class="o">;</span>
           <span class="kt">float</span><span class="o">[]</span> <span class="n">imaginary</span><span class="o">;</span>
        
          <span class="n">BandStopFilter</span> <span class="o">(</span><span class="kt">float</span><span class="o">[]</span> <span class="n">_real</span><span class="o">){</span>
             <span class="n">real</span> <span class="o">=</span> <span class="n">_real</span><span class="o">;</span>
             <span class="n">imaginary</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">float</span><span class="o">[</span><span class="n">_real</span><span class="o">.</span><span class="na">length</span><span class="o">];</span>
        
          <span class="o">}</span>
        
          <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
             <span class="n">fft</span><span class="o">.</span><span class="na">forward</span><span class="o">(</span><span class="n">real</span><span class="o">,</span> <span class="n">imaginary</span><span class="o">);</span>
          <span class="o">}</span>
        <span class="o">}</span>
        </code></pre>
        <p>The main method then would just execute the Kernel using the familiar kernel.execute() method :-</p>
        <pre class="highlight java"><code>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
           <span class="kt">float</span><span class="o">[]</span> <span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">float</span><span class="o">[</span><span class="mi">1024</span><span class="o">];</span>
           <span class="n">BandStopFilter</span>  <span class="n">kernel</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BandStopFilter</span> <span class="o">(</span><span class="n">data</span><span class="o">);</span>
           <span class="n">kernel</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
        <span class="o">}</span>
        </code></pre>
        <p>Essentially we want the <code>FFT.forward(float[] _real, float[] _imaginary)</code> and <code>FFT.reverse(float[] _real, float[] _imaginary)</code> methods to be callable from Aparapi Kernel code. We want Aparapi to handle the call-forwarding and the argument/buffer mapping transfers. We want Aparapi to call the Java methods normally if OpenCL is not available but would like Aparapi to use the implementor provided OpenCL if it is. So the implementor will be required to provide both a Java and an OpenCL version of the callable methods because Aparapi will decide which version needs to be called ant runtime.</p>
        
        <p>Any extension point is required to implement the AparapiExtensionPoint interface.</p>
        <pre class="highlight java"><code>
        <span class="kd">public</span> <span class="kd">class</span> <span class="nc">AparapiExtensionPoint</span>
           <span class="kd">public</span> <span class="n">String</span> <span class="nf">getOpenCL</span><span class="o">();</span>
        <span class="o">}</span>
        </code></pre>
        <p>Here is a possible (although incomplete) FFT implementation.</p>
        <pre class="highlight java"><code>
        <span class="kd">public</span> <span class="kd">class</span> <span class="nc">FFT</span> <span class="kd">implements</span> <span class="n">AparapiExtensionPoint</span><span class="o">{</span>
            <span class="nd">@AparapiCallable</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">forward</span><span class="o">(</span>
                <span class="nd">@Global</span> <span class="nd">@ReadWrite</span> <span class="kt">float</span><span class="o">[]</span> <span class="n">_data</span><span class="o">,</span>
                <span class="nd">@Global</span> <span class="nd">@ReadWrite</span> <span class="kt">float</span><span class="o">[]</span> <span class="n">_imaginary</span><span class="o">)</span> <span class="o">{</span>
                  <span class="c1">// java implementation</span>
               <span class="o">}</span>
        
            <span class="nd">@AparapiCallable</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">reverse</span><span class="o">(</span>
                <span class="nd">@Global</span> <span class="nd">@ReadWrite</span> <span class="kt">float</span><span class="o">[]</span> <span class="n">_data</span><span class="o">,</span>
                <span class="nd">@Global</span> <span class="nd">@ReadWrite</span> <span class="kt">float</span><span class="o">[]</span> <span class="n">_imaginary</span><span class="o">)</span> <span class="o">{</span>
                  <span class="c1">// java implementation</span>
                <span class="o">}</span>
        
            <span class="nd">@Override</span> <span class="kd">public</span> <span class="n">String</span> <span class="nf">getOpenCL</span><span class="o">()</span> <span class="o">{</span>
                  <span class="k">return</span> <span class="s">""</span>
                  <span class="o">+</span><span class="s">"void my_package_FFT_forward("</span>
                  <span class="o">+</span><span class="s">"   __global float* _real,"</span>
                  <span class="o">+</span><span class="s">"   __global float* _imaginary )"</span>
                  <span class="o">+</span><span class="s">"   {"</span>
                  <span class="o">+</span><span class="s">"       // OpenCL implemention"</span>
                  <span class="o">+</span><span class="s">"   }"</span>
                  <span class="o">+</span><span class="s">"void my_package_FFT_reverse("</span>
                  <span class="o">+</span><span class="s">"   __global float* _real,"</span>
                  <span class="o">+</span><span class="s">"   __global float* _imaginary )"</span>
                  <span class="o">+</span><span class="s">"   {"</span>
                  <span class="o">+</span><span class="s">"       // OpenCL implemention"</span>
                  <span class="o">+</span><span class="s">"   }"</span><span class="o">;</span>
               <span class="o">}</span>
        <span class="o">}</span>
        </code></pre>
        <p>The implementer’s class will be required to define the callable aparapi methods as well as implement the <code>getOpenCL()</code> method so that the OpenCL implementation of those methods can be extracted at run-time.</p>
        
        <p>Aparapi will provide annotations to decorate the methods and args/parameters of the exposed callable methods . These annotations provide information so that Aparapi locate the callable methods as well as parameter hints to help coordinate buffer types (global, local, constant) and transfer directions (read,write, readWrite) when executing the methods from a Kernel. This information is consulted during the normal bytecode analysis that Aparapi provides when Aparapi hits the call site.</p>
        
        <p>Note that the Java code inside the <code>@AparapiCallable</code> functions (or code executed from it) is not constrained to the normal Aparapi subset. It can be any legitimate Java code, but should be thread safe (because it will be called from JTP mode!).</p>
        
        <p>Note also that the OpenCL code yielded from the <code>getOpenCL()</code> method is assumed to be complete, Aparapi does not attempt to parse this code. If the code fails to compile Aparapi will fallback and execute the whole Kernel in JTP mode.</p>
        
        <p>BTW we show getOpenCL() returning a String literal. This is most likely to be how code is returned. However, it could be extracted from a File? a resource in the Jar file? or dynamically generated based on some state. For example an FFT implementation might choose to use different code for radix2 or radix4 implementations (based on a paramater passed to <code>FFT()</code> constructor - say <code>FFT(FFT.RADIX2))</code> in which case the getOpenCL() method might yield different code.</p>
        
        <p>The above proposal covers the case where a third party might want to provide an Aparapi extension point as a library.</p>
        
        <p>We might also consider allowing single methods within the Kernel to be optimized, where the OpenCL is made available via the AparapiCallable annotation. The method would still use the same Annotations for the args (to allow buffer txfers to be optimized).</p>
        <pre class="highlight java"><code>
        <span class="n">Kernel</span> <span class="n">k</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Kernel</span><span class="o">(){</span>
              <span class="nd">@AparapiCallable</span><span class="o">(</span><span class="err">”</span> <span class="cm">/* opencl code for sum() goes here */</span><span class="err">”</span><span class="o">)</span>
               <span class="kt">int</span> <span class="nf">sum</span><span class="o">(</span><span class="nd">@Global</span> <span class="nd">@ReadWrite</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">data</span><span class="o">,</span> <span class="kt">int</span> <span class="n">length</span><span class="o">){</span>
                     <span class="kt">int</span>  <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                     <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="nl">v:</span><span class="n">data</span><span class="o">){</span>
                            <span class="n">sum</span><span class="o">+=</span><span class="n">v</span><span class="o">;</span>
                     <span class="o">}</span>
              <span class="o">}</span>
             <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(){</span>
                    <span class="n">sum</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
             <span class="o">}</span>
        <span class="o">}</span>
        </code></pre>
        <p>Here are the proposed new interfaces/annotations</p>
        <pre class="highlight java"><code>
        <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AparapiExtensionPoint</span> <span class="o">{</span>
           <span class="kd">public</span> <span class="n">String</span> <span class="nf">getOpenCL</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="nd">@Retention</span><span class="o">(</span><span class="n">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span> <span class="nd">@Target</span><span class="o">(</span><span class="n">ElementType</span><span class="o">.</span><span class="na">METHOD</span><span class="o">)</span>
        <span class="kd">public</span> <span class="nd">@interface</span> <span class="n">AparapiCallable</span> <span class="o">{</span>
             <span class="n">String</span> <span class="n">value</span> <span class="k">default</span> <span class="n">NULL</span><span class="o">;</span>
        <span class="o">}</span>
        
        <span class="nd">@Retention</span><span class="o">(</span><span class="n">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span> <span class="nd">@Target</span><span class="o">(</span><span class="n">ElementType</span><span class="o">.</span><span class="na">PARAMETER</span><span class="o">)</span>
        <span class="kd">public</span> <span class="nd">@interface</span> <span class="n">Global</span> <span class="o">{}</span>
        
        <span class="nd">@Retention</span><span class="o">(</span><span class="n">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span> <span class="nd">@Target</span><span class="o">(</span><span class="n">ElementType</span><span class="o">.</span><span class="na">PARAMETER</span><span class="o">)</span>
        <span class="kd">public</span> <span class="nd">@interface</span> <span class="n">Local</span> <span class="o">{}</span>
        
        <span class="nd">@Retention</span><span class="o">(</span><span class="n">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span> <span class="nd">@Target</span><span class="o">(</span><span class="n">ElementType</span><span class="o">.</span><span class="na">PARAMETER</span><span class="o">)</span>
        <span class="kd">public</span> <span class="nd">@interface</span> <span class="n">Constant</span> <span class="o">{}</span>
        
        <span class="nd">@Retention</span><span class="o">(</span><span class="n">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span> <span class="nd">@Target</span><span class="o">(</span><span class="n">ElementType</span><span class="o">.</span><span class="na">PARAMETER</span><span class="o">)</span>
        <span class="kd">public</span> <span class="nd">@interface</span> <span class="n">ReadWrite</span> <span class="o">{}</span>
        
        <span class="nd">@Retention</span><span class="o">(</span><span class="n">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span> <span class="nd">@Target</span><span class="o">(</span><span class="n">ElementType</span><span class="o">.</span><span class="na">PARAMETER</span><span class="o">)</span>
        <span class="kd">public</span> <span class="nd">@interface</span> <span class="n">ReadOnly</span> <span class="o">{}</span>
        
        <span class="nd">@Retention</span><span class="o">(</span><span class="n">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span> <span class="nd">@Target</span><span class="o">(</span><span class="n">ElementType</span><span class="o">.</span><span class="na">PARAMETER</span><span class="o">)</span>
        <span class="kd">public</span> <span class="nd">@interface</span> <span class="n">WriteOnly</span> <span class="o">{}</span>
        </code></pre>
        <p>And here is the example code in one chunk</p>
        <pre class="highlight java"><code>
        <span class="kd">public</span> <span class="kd">class</span> <span class="nc">FFT</span> <span class="kd">implements</span> <span class="n">AparapiExtensionPoint</span><span class="o">{</span>
            <span class="nd">@AparapiCallable</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">forward</span><span class="o">(</span>
                <span class="nd">@Global</span> <span class="nd">@ReadWrite</span> <span class="kt">float</span><span class="o">[]</span> <span class="n">_data</span><span class="o">,</span>
                <span class="nd">@Global</span> <span class="nd">@ReadWrite</span> <span class="kt">float</span><span class="o">[]</span> <span class="n">_imaginary</span><span class="o">)</span> <span class="o">{</span>
                  <span class="c1">// java implementation</span>
               <span class="o">}</span>
        
          <span class="nd">@AparapiCallable</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">reverse</span><span class="o">(</span>
              <span class="nd">@Global</span> <span class="nd">@ReadWrite</span> <span class="kt">float</span><span class="o">[]</span> <span class="n">_data</span><span class="o">,</span>
              <span class="nd">@Global</span> <span class="nd">@ReadWrite</span> <span class="kt">float</span><span class="o">[]</span> <span class="n">_imaginary</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// java implementation</span>
              <span class="o">}</span>
        
          <span class="nd">@Override</span> <span class="kd">public</span> <span class="n">String</span> <span class="nf">getOpenCL</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">return</span> <span class="s">""</span>
                <span class="o">+</span><span class="s">"void my_package_FFT_forward("</span>
                <span class="o">+</span><span class="s">"   __global float* _real,"</span>
                <span class="o">+</span><span class="s">"   __global float* _imaginary )"</span>
                <span class="o">+</span><span class="s">"   {"</span>
                <span class="o">+</span><span class="s">"       // OpenCL implemention"</span>
                <span class="o">+</span><span class="s">"   }"</span>
                <span class="o">+</span><span class="s">"void my_package_FFT_reverse("</span>
                <span class="o">+</span><span class="s">"   __global float* _real,"</span>
                <span class="o">+</span><span class="s">"   __global float* _imaginary )"</span>
                <span class="o">+</span><span class="s">"   {"</span>
                <span class="o">+</span><span class="s">"       // OpenCL implemention"</span>
                <span class="o">+</span><span class="s">"   }"</span><span class="o">;</span>
             <span class="o">}</span>
        <span class="o">}</span>
        
        <span class="kd">public</span> <span class="kd">class</span> <span class="nc">BandStopFilter</span> <span class="kd">extends</span> <span class="n">Kernel</span><span class="o">{</span>
           <span class="n">FFT</span> <span class="n">fft</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FFT</span><span class="o">();</span>
           <span class="kt">float</span><span class="o">[]</span> <span class="n">real</span><span class="o">;</span>
           <span class="kt">float</span><span class="o">[]</span> <span class="n">imaginary</span><span class="o">;</span>
        
           <span class="n">BandStopFilter</span> <span class="o">(</span><span class="kt">float</span><span class="o">[]</span> <span class="n">_real</span><span class="o">){</span>
              <span class="n">real</span> <span class="o">=</span> <span class="n">_real</span><span class="o">;</span>
              <span class="n">imaginary</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">float</span><span class="o">[</span><span class="n">_real</span><span class="o">.</span><span class="na">length</span><span class="o">];</span>
        
           <span class="o">}</span>
        
           <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
              <span class="n">fft</span><span class="o">.</span><span class="na">forward</span><span class="o">(</span><span class="n">real</span><span class="o">,</span> <span class="n">imaginary</span><span class="o">);</span>
           <span class="o">}</span>
        <span class="o">}</span>
        
        <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
           <span class="kt">float</span><span class="o">[]</span> <span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">float</span><span class="o">[</span><span class="mi">1024</span><span class="o">];</span>
           <span class="n">BandStopFilter</span>  <span class="n">kernel</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BandStopFilter</span> <span class="o">(</span><span class="n">data</span><span class="o">);</span>
           <span class="n">kernel</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
        <span class="o">}</span>
        </code></pre>
        <p>After discussion I think we are converging on a less complex solution. This is based on Witold&rsquo;s feedback suggestion (see below) where we use OpenCL annotations rather than forcing the implementation of the interface and the <code>getOpenCL()</code> method as originally suggested.</p>
        
        <p>So we will create an <code>@OpenCL</code> annotation for classes/methods.</p>
        
        <p>The <code>@OpenCL</code> annotation on the methods will contain the OpenCL source replacement for a specific method. The arg list will be created by Aparapi.</p>
        
        <p>The @OpenCL annotation on a class allows us to optionally introduce common code (helper methods, #pragmas, constants) which will precede the method declarations in the OpenCL code.</p>
        
        <p>So an FFT example whereby forward() and reverse() methods both called a common foo() method might look like this.</p>
        <pre class="highlight java"><code>
        <span class="nd">@OpenCL</span><span class="o">(</span><span class="n">common</span><span class="o">=</span><span class="s">"/* common void foo(){} + maybe #pragmas + accessable
        global fields declared here */"</span><span class="o">)</span>
        <span class="kd">public</span> <span class="kd">class</span> <span class="nc">FFT</span> <span class="kd">extends</span> <span class="n">AparapiExtensionPoint</span> <span class="o">{</span>
              <span class="nd">@OpenCL</span><span class="o">(</span><span class="n">signature</span><span class="o">=</span><span class="s">"//function signature - OPTIONAL"</span><span class="o">,</span> <span class="n">body</span><span class="o">=</span><span class="s">"{ /* uses foo(); */ }"</span><span class="o">)</span>
              <span class="kd">public</span> <span class="kt">void</span> <span class="nf">forward</span><span class="o">(</span>
                  <span class="nd">@Global</span> <span class="nd">@ReadWrite</span> <span class="kt">float</span><span class="o">[]</span> <span class="n">_data</span><span class="o">,</span>
                  <span class="nd">@Global</span> <span class="nd">@ReadWrite</span> <span class="kt">float</span><span class="o">[]</span> <span class="n">_imaginary</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// java implementation</span>
                 <span class="o">}</span>
              <span class="nd">@OpenCL</span><span class="o">(</span><span class="n">function</span><span class="o">=</span><span class="s">"{  /*uses foo(); */) }"</span><span class="o">)</span>
              <span class="kd">public</span> <span class="kt">void</span> <span class="nf">reverse</span><span class="o">(</span>
                  <span class="nd">@Global</span> <span class="nd">@ReadWrite</span> <span class="kt">float</span><span class="o">[]</span> <span class="n">_data</span><span class="o">,</span>
                  <span class="nd">@Global</span> <span class="nd">@ReadWrite</span> <span class="kt">float</span><span class="o">[]</span> <span class="n">_imaginary</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// java implementation</span>
                  <span class="o">}</span>
           <span class="o">}</span>
        <span class="o">}</span>
        </code></pre>
        <p>To invoke from an Aparapi kernel. We should be able to do something like</p>
        <pre class="highlight java"><code>
        <span class="kd">public</span> <span class="kd">class</span> <span class="nc">BandStopFilter</span> <span class="kd">extends</span> <span class="n">Kernel</span><span class="o">{</span>
             <span class="n">FFT</span> <span class="n">fft</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FFT</span><span class="o">();</span>
             <span class="kt">float</span><span class="o">[]</span> <span class="n">real</span><span class="o">;</span>
             <span class="kt">float</span><span class="o">[]</span> <span class="n">imaginary</span><span class="o">;</span>
        
             <span class="n">BandStopFilter</span> <span class="o">(</span><span class="kt">float</span><span class="o">[]</span> <span class="n">_real</span><span class="o">){</span>
                <span class="n">real</span> <span class="o">=</span> <span class="n">_real</span><span class="o">;</span>
                <span class="n">imaginary</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">float</span><span class="o">[</span><span class="n">_real</span><span class="o">.</span><span class="na">length</span><span class="o">];</span>
        
             <span class="o">}</span>
        
             <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="n">fft</span><span class="o">.</span><span class="na">forward</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">real</span><span class="o">,</span> <span class="n">imaginary</span><span class="o">);</span>
             <span class="o">}</span>
          <span class="o">}</span>
        
          <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
             <span class="kt">float</span><span class="o">[]</span> <span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">float</span><span class="o">[</span><span class="mi">1024</span><span class="o">];</span>
             <span class="n">BandStopFilter</span>  <span class="n">kernel</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BandStopFilter</span> <span class="o">(</span><span class="n">data</span><span class="o">);</span>
             <span class="n">kernel</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
          <span class="o">}</span>
        <span class="o">}</span>
        </code></pre>
        <p>Ideally we would also like to invoke FFT directly (instead of via a Kernel). This is tricky because the forward()} and reverse() methods will need to be invoked across a range and of course the dispatch across the range needs to be initiated from Aparapi.</p>
        
        <p>The only way I can see how to do this is to force the creation of an interface so we can use Java&rsquo;s existing Proxy mechanism to create a wrapper.</p>
        <pre class="highlight java"><code>
        <span class="nd">@OpenCL</span><span class="o">(</span><span class="n">wraps</span><span class="o">=</span><span class="n">FFT</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="kd">interface</span> <span class="nc">FFTInterface</span><span class="o">{</span>
         <span class="kd">public</span> <span class="kt">void</span> <span class="nf">forward</span><span class="o">(</span>  <span class="n">Range</span> <span class="n">_range</span><span class="o">,</span> <span class="kt">float</span><span class="o">[]</span> <span class="n">_data</span><span class="o">,</span>  <span class="kt">float</span><span class="o">[]</span> <span class="n">_imaginary</span><span class="o">);</span>
             <span class="kd">public</span> <span class="kt">void</span> <span class="nf">reverse</span><span class="o">(</span> <span class="n">Range</span> <span class="n">_range</span><span class="o">,</span> <span class="kt">float</span><span class="o">[]</span> <span class="n">_data</span><span class="o">,</span> <span class="kt">float</span><span class="o">[]</span> <span class="n">_imaginary</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">Then</span> <span class="n">provide</span> <span class="n">a</span> <span class="n">mechanism</span> <span class="k">for</span> <span class="n">extracting</span> <span class="n">a</span> <span class="n">proxy</span> <span class="n">and</span> <span class="n">invoking</span> <span class="n">it</span><span class="o">.</span>
        
        <span class="kt">float</span><span class="o">[]</span> <span class="n">real</span> <span class="o">=</span> <span class="c1">//??</span>
        <span class="kt">float</span><span class="o">[]</span> <span class="n">imag</span> <span class="o">=</span> <span class="c1">//??</span>
        <span class="n">Aparapi</span><span class="o">.</span><span class="na">wrap</span><span class="o">&lt;</span><span class="n">FFT</span><span class="o">&gt;(</span><span class="n">FFTInterface</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">forward</span><span class="o">(</span><span class="n">range</span><span class="o">,</span> <span class="n">real</span><span class="o">,</span> <span class="n">imag</span><span class="o">);</span>
        </code></pre>
        <p>I can&rsquo;t see a cleaner solution.</p>
      </div>
    </main>
    <footer class='page-footer'>
      <div class='container'>
        <div class='row'>
          <div class='col l4 s12'>
            <h5 class='white-text'>Help Aparapi Grow</h5>
            <p class='grey-text text-lighten-4'>We are a team of volunteers working on this project like it's our full time job. Any amount would help support and continue development on this project and is greatly appreciated.</p>
            <form action='https://www.paypal.com/cgi-bin/webscr' id='paypal-donate' method='post' target='_top'>
              <input name='cmd' type='hidden' value='_s-xclick'>
              <input name='encrypted' type='hidden' value='-----BEGIN PKCS7-----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-----END PKCS7-----'>
              <button alt='PayPal - The safer, easier way to pay online!' class='btn waves-effect waves-light red lighten-3' name='action' type='submit'>
                Donate Now
              </button>
            </form>
          </div>
          <div class='col l4 s12'>
            <h5 class='white-text'>Join the Discussion</h5>
            <p class='grey-text text-lighten-4'>We have a Gitter chat room set up where you can talk directly with us. Come in and discuss new features, future goals, general problems or questions, or anything else you can think of.</p>
            <a class='btn waves-effect waves-light red lighten-3' href='https://gitter.im/Syncleus/aparapi' target='_blank'>Chat</a>
          </div>
          <div class='col l4 s12' style='overflow: hidden;'>
            <h5 class='white-text'>Connect</h5>
            <iframe allowtransparency='true' frameborder='0' height='30' scrolling='0' src='http://ghbtns.com/github-btn.html?user=Syncleus&amp;repo=aparapi&amp;type=watch&amp;count=true&amp;size=large' width='170'></iframe>
            <br>
            <a class='twitter-follow-button' data-dnt='true' data-show-count='true' data-size='large' href='https://twitter.com/AparapiLib'>Follow @AparapiLib</a>
            <br>
            <div class='g-follow' data-annotation='bubble' data-height='24' data-href='https://plus.google.com/102266131584900704956' data-rel='publisher'></div>
          </div>
        </div>
      </div>
      <div class='footer-copyright'>
        <div class='container'>
          © 2016-2017 Syncleus, All rights reserved.
          <a class='grey-text text-lighten-4 right' href='https://github.com/Syncleus/aparapi/blob/master/LICENSE'>Apache License v2</a>
        </div>
      </div>
    </footer>
    <!-- Scripts -->
    <script src='https://code.jquery.com/jquery-2.1.4.min.js'></script>
    <script>
      if (!window.jQuery) { document.write('<script src="bin/jquery-2.1.1.min.js"><\/script>'); }
    </script>
    <script src='/javascripts/jquery.timeago.js'></script>
    <script src='/javascripts/materialize.min.js'></script>
    <script src='/javascripts/lunr.min.js'></script>
    <script src='/javascripts/search.js'></script>
    <script src='/javascripts/materialize.js'></script>
    <script src='/javascripts/init.js'></script>
    <!-- Twitter Button -->
    <script>
      !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');
    </script>
    <!-- Google Plus Button -->
    <script async='' defer='defer' src='https://apis.google.com/js/platform.js'></script>
  </body>
</html>
