<!DOCTYPE html>
<html lang='en'>
<head>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
<meta content='width=device-width, initial-scale=1' name='viewport'>
<meta content='IE=edge' http-equiv='X-UA-Compatible'>
<meta content='no' name='msapplication-tap-highlight'>
<meta content='Aparapi is an Open-source framework for executing native Java code on the GPU, developed by Syncleus.' name='description'>
<title>
Aparapi | Multiple Dim ND Range
</title>
<!-- Favicons -->
<link href='/images/favicon/apple-touch-icon-152x152.png' rel='apple-touch-icon-precomposed'>
<meta content='#FFFFFF' name='msapplication-TileColor'>
<meta content='/images/favicon/mstile-144x144.png' name='msapplication-TileImage'>
<link href='/images/favicon/favicon-32x32.png' rel='icon' sizes='32x32'>
<!-- Android 5 Chrome Color -->
<meta content='#EE6E73' name='theme-color'>
<!-- CSS -->
<link href='/stylesheets/highlight.css' media='screen,projection' rel='stylesheet' type='text/css'>
<link href='/stylesheets/style.css' media='screen,projection' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/icon?family=Material+Icons' rel='stylesheet'>
</head>
<body>
<header>
<div class='container'>
<a class='button-collapse top-nav waves-effect waves-light circle hide-on-large-only' data-activates='nav-mobile' href='#'>
<i class='material-icons'>menu</i>
</a>
</div>
<ul class='side-nav fixed' id='nav-mobile'>
<li class='logo'>
<a class='brand-logo' href='/' id='logo-container'>
<object data='/images/logo.svg' id='front-page-logo' type='image/svg+xml'>Your browser does not support SVG</object>
</a>
</li>
<li class='search'>
<div class='search-wrapper card'>
<input id='search'>
<i class='material-icons'>search</i>
<div class='search-results'></div>
</div>
</li>
<li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/">Overview</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a class='collapsible-header waves-effect waves-teal'>Introduction</a><div class='collapsible-body'><ul><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/introduction/about.html">About</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/introduction/getting-started.html">Getting Started</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/introduction/faq.html">FAQ</a></li></ul></li></ul></div></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a class='collapsible-header waves-effect waves-teal'>Documentation</a><div class='collapsible-body'><ul><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/aparapi-patterns.html">Aparapi Patterns</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/choosing-specific-devices.html">Choosing Specific Devices</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/converting-java-to-opencl.html">Converting Java to OpenCL</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/emulating-multiple-entrypoints.html">Emulating Multiple Entrypoints</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/explicit-buffer-handling.html">Explicit Buffer Handling</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/hsa-enabled-lambda.html">HSA Enabled Lambda</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/kernel-guidelines.html">Kernel Guidelines</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/library-agent-duality.html">Library Agent Duality</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/new-features.html">New Features</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/opencl-bindings.html">OpenCL Bindings</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/private-memory-space.html">Private Memory Space</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/profiling-the-kernel.html">Profiling the Kernel</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/setting-up-hsa.html">Setting Up HSA</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/unit-tests.html">Unit Tests</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/using-hsa-simulator.html">Using HSA Simulator</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/constant-memory.html">Constant Memory</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/local-memory.html">Local Memory</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/documentation/multiple-dim-ranges.html">Multiple Dim Ranges</a></li></ul></li></ul></div></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a class='collapsible-header waves-effect waves-teal'>Proposals</a><div class='collapsible-body'><ul><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/proposals/multiple-dim-nd-range.html">Multiple Dim ND Range</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/proposals/lambdas.html">Lambdas</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/proposals/address-space-with-buffers.html">Address Space with Buffers</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/proposals/extensions.html">Extensions</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/proposals/device.html">Device</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/proposals/multiple-entry-points.html">Multiple Entry Points</a></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/proposals/lambda-syntax.html">Lambda Syntax</a></li></ul></li></ul></div></li></ul></li><li class='no-padding'><ul class='collapsible collapsible-accordion'><li class='bold'><a href="/showcase.html">Showcase</a></li></ul></li>
</ul>
</header>
<main>
<div class='section no-pad-bot' id='index-banner'>
<div class='container'>
<h1 class='header center-on-small-only'>Multiple Dim ND Range</h1>
<div class='row center'>
<h4 class='header col s12 light center'>A proposal for accessing multi-dim ND range execution.</h4>
</div>

</div>

</div>
<div class='container'>
<p>We can discuss this proposal either here (in comments) or via the discussion list here.</p>

<p>Note this is nothing to do with accessing Java 2D arrays in Aparapi. This discussion is focused on the ability to expose the execution of kernels over 1, 2 or 3 dimensions. The memory in each case is a single contiguous region (like a single dimension primitive array).</p>

<p>At present an Aparapi kernel can only be executed using a single dimension. If we wish to represent execution over WIDTH x HEIGHT element grid we would execute over the range (WIDTH*HEIGHT) and manually divide/mod getGlobalID() by WIDTH to determine the x and y for each.</p>

<p>Similarly we would multiply y by WIDTH and add x (y*WIDTH+x) to convert an X,Y location to a linear global id</p>
<div class="highlight"><pre class="highlight java"><code>
<span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">WIDTH</span><span class="o">=</span><span class="mi">128</span><span class="o">;</span>
<span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">HEIGHT</span><span class="o">=</span><span class="mi">64</span><span class="o">;</span>
<span class="kd">final</span> <span class="kt">int</span> <span class="n">in</span><span class="o">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="n">WIDTH</span><span class="o">*</span><span class="n">HEIGHT</span><span class="o">];</span>
<span class="kd">final</span> <span class="kt">int</span> <span class="n">out</span><span class="o">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="n">WIDTH</span><span class="o">*</span><span class="n">HEIGHT</span><span class="o">];</span>
<span class="n">Kernel</span> <span class="n">kernel</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Kernel</span><span class="o">(){</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(){</span>
      <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">getGlobaId</span><span class="o">()%</span><span class="n">WIDTH</span><span class="o">;</span>
      <span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="n">getGlobalID</span><span class="o">()/</span><span class="n">WIDTH</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(!(</span><span class="n">x</span><span class="o">==</span><span class="mi">1</span> <span class="o">||</span> <span class="n">x</span><span class="o">==(</span><span class="n">WIDTH</span><span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">||</span> <span class="n">y</span><span class="o">==</span><span class="mi">1</span> <span class="o">||</span> <span class="n">y</span><span class="o">==(</span><span class="n">HEIGHT</span><span class="o">-</span><span class="mi">1</span><span class="o">)){</span>
         <span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
         <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">dx</span> <span class="o">=-</span><span class="mi">1</span><span class="o">;</span> <span class="n">dx</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">;</span> <span class="n">dx</span><span class="o">++){</span>
           <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">dy</span> <span class="o">=-</span><span class="mi">1</span><span class="o">;</span> <span class="n">dy</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">;</span> <span class="n">dy</span><span class="o">++){</span>
             <span class="n">sum</span><span class="o">+=</span><span class="n">in</span><span class="o">[(</span><span class="n">y</span><span class="o">+</span><span class="n">dy</span><span class="o">)*</span><span class="n">WIDTH</span><span class="o">+(</span><span class="n">x</span><span class="o">+</span><span class="n">dx</span><span class="o">)];</span>
           <span class="o">}</span>
         <span class="o">}</span>
         <span class="n">out</span><span class="o">[</span><span class="n">y</span><span class="o">*</span><span class="n">WIDTH</span><span class="o">+</span><span class="n">x</span><span class="o">]</span> <span class="o">=</span> <span class="n">sum</span><span class="o">/</span><span class="mi">9</span><span class="o">;</span>
         <span class="c1">// or out[getGlobalID()] = sum/9;</span>
      <span class="o">}</span>
   <span class="o">}</span>

<span class="o">};</span>
<span class="n">kernel</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">WIDTH</span><span class="o">*</span><span class="n">HEIGHT</span><span class="o">);</span>
</code></pre></div>
<p>OpenCL natively allows the user to execute over 1, 2 or 3 dimension grids via the clEnqueueNDRangeKernel() method.</p>

<p>We chose not to expose this in Aparapi but there have been requests for us to allow it.</p>

<p>There are a number of things to consider here:</p>

<ol>
<li>Extending the syntax of kernel.execute() to allow multi dimensional grids.</li>
<li>Mapping Kernel methods to OpenCL&rsquo;s get<em>local</em>id(int dim), get<em>local</em>size(int dim), get<em>group</em>id(int<em>dim), etc. At present we map kernel.getGlobalId() to get</em>local_id(0).</li>
<li>Handling all of these when an application drops back to JTP mode.</li>
</ol>

<h2>Extending Kernel.execute(int range)</h2>

<p>Sadly we can&rsquo;t overload Kernel.execute(int range), Kernel.execute(int xrange, int yrange) and Kernel.execute(int xrange, int yrange, int zrange) because we already have kernel.execute(int, int) mapped for executing mutiple passes over the linear range.</p>

<p>Remember</p>
<div class="highlight"><pre class="highlight java"><code>
<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">pass</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">pass</span><span class="o">&lt;</span><span class="mi">20</span><span class="o">;</span> <span class="n">pass</span><span class="o">++){</span>
   <span class="n">kernel</span><span class="o">(</span><span class="mi">1024</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div>
<p>Is equivalent to</p>
<div class="highlight"><pre class="highlight java"><code>
<span class="n">kernel</span><span class="o">(</span><span class="mi">1024</span><span class="o">,</span> <span class="mi">20</span><span class="o">);</span>
</code></pre></div>
<p>I think I would prefer</p>
<div class="highlight"><pre class="highlight java"><code>
<span class="n">Kernel</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="kt">int</span> <span class="n">range</span><span class="o">)</span>
<span class="n">Kernel</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="kt">int</span> <span class="n">range</span><span class="o">,</span> <span class="kt">int</span> <span class="n">passes</span><span class="o">)</span>
<span class="n">Kernel</span><span class="o">.</span><span class="na">executeXY</span><span class="o">(</span><span class="kt">int</span> <span class="n">xrange</span><span class="o">,</span> <span class="kt">int</span> <span class="n">yrange</span><span class="o">)</span>
<span class="n">Kernel</span><span class="o">.</span><span class="na">executeXY</span><span class="o">(</span><span class="kt">int</span> <span class="n">xrange</span><span class="o">,</span> <span class="kt">int</span> <span class="n">yrange</span><span class="o">,</span> <span class="kt">int</span> <span class="n">passes</span><span class="o">)</span>
<span class="n">Kernel</span><span class="o">.</span><span class="na">executeXYZ</span><span class="o">(</span><span class="kt">int</span> <span class="n">xrange</span><span class="o">,</span> <span class="kt">int</span> <span class="n">yrange</span><span class="o">,</span> <span class="kt">int</span> <span class="n">zrange</span><span class="o">)</span>
<span class="n">Kernel</span><span class="o">.</span><span class="na">executeXYZ</span><span class="o">(</span><span class="kt">int</span> <span class="n">xrange</span><span class="o">,</span> <span class="kt">int</span> <span class="n">yrange</span><span class="o">,</span> <span class="kt">int</span> <span class="n">zrange</span><span class="o">,</span> <span class="kt">int</span> <span class="n">passes</span><span class="o">)</span>
</code></pre></div>
<p>Obviously in the above calls we are only supplying the global bounds for the grid. We could also provide mappings allowing local ranges. I think I would prefer</p>
<div class="highlight"><pre class="highlight java"><code>
<span class="n">Kernel</span><span class="o">.</span><span class="na">executeLocal</span><span class="o">(</span><span class="kt">int</span> <span class="n">range</span><span class="o">,</span> <span class="kt">int</span> <span class="n">local</span><span class="o">)</span>
<span class="n">Kernel</span><span class="o">.</span><span class="na">executeLocal</span><span class="o">(</span><span class="kt">int</span> <span class="n">range</span><span class="o">,</span> <span class="kt">int</span> <span class="n">local</span><span class="o">,</span> <span class="kt">int</span> <span class="n">passes</span><span class="o">)</span>
<span class="n">Kernel</span><span class="o">.</span><span class="na">executeXYLocal</span><span class="o">(</span><span class="kt">int</span> <span class="n">xrange</span><span class="o">,</span> <span class="kt">int</span> <span class="n">yrange</span><span class="o">,</span> <span class="kt">int</span> <span class="n">xlocalrange</span><span class="o">,</span> <span class="kt">int</span> <span class="n">ylocalrange</span><span class="o">)</span>
<span class="n">Kernel</span><span class="o">.</span><span class="na">executeXYLocal</span><span class="o">(</span><span class="kt">int</span> <span class="n">xrange</span><span class="o">,</span> <span class="kt">int</span> <span class="n">yrange</span><span class="o">,</span> <span class="kt">int</span> <span class="n">xlocalrange</span><span class="o">,</span> <span class="kt">int</span> <span class="n">ylocalrange</span><span class="o">,</span> <span class="kt">int</span> <span class="n">passes</span><span class="o">)</span>
<span class="n">Kernel</span><span class="o">.</span><span class="na">executeXYZLocal</span><span class="o">(</span><span class="kt">int</span> <span class="n">xrange</span><span class="o">,</span> <span class="kt">int</span> <span class="n">yrange</span><span class="o">,</span> <span class="kt">int</span> <span class="n">zrange</span><span class="o">,</span> <span class="kt">int</span> <span class="n">xlocalrange</span><span class="o">,</span> <span class="kt">int</span> <span class="n">ylocalrange</span><span class="o">,</span> <span class="kt">int</span> <span class="n">zlocalrange</span><span class="o">)</span>
<span class="n">Kernel</span><span class="o">.</span><span class="na">executeXYZLocal</span><span class="o">(</span><span class="kt">int</span> <span class="n">xrange</span><span class="o">,</span> <span class="kt">int</span> <span class="n">yrange</span><span class="o">,</span> <span class="kt">int</span> <span class="n">zrange</span><span class="o">,</span> <span class="kt">int</span> <span class="n">xlocalrange</span><span class="o">,</span> <span class="kt">int</span> <span class="n">ylocalrange</span><span class="o">,</span> <span class="kt">int</span> <span class="n">zlocalrange</span><span class="o">,</span> <span class="kt">int</span> <span class="n">passes</span><span class="o">)</span>
</code></pre></div>
<p>Another alternative may be to create Range classes</p>
<div class="highlight"><pre class="highlight java"><code>
<span class="kd">class</span> <span class="nc">Range</span><span class="o">{</span>
  <span class="kt">int</span> <span class="n">passes</span><span class="o">;</span>
  <span class="kt">int</span> <span class="n">width</span><span class="o">;</span>
  <span class="kd">static</span> <span class="n">Range</span> <span class="nf">create</span><span class="o">(</span><span class="kt">int</span> <span class="n">width</span><span class="o">);</span>
  <span class="kd">static</span> <span class="n">Range</span> <span class="nf">create</span><span class="o">(</span><span class="kt">int</span> <span class="n">width</span><span class="o">,</span> <span class="kt">int</span> <span class="n">passes</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Range2D</span> <span class="kd">extends</span> <span class="n">Range</span><span class="o">{</span>
   <span class="kt">int</span> <span class="n">height</span><span class="o">;</span>
   <span class="kd">static</span> <span class="n">Range</span> <span class="nf">create</span><span class="o">(</span><span class="kt">int</span> <span class="n">width</span><span class="o">,</span> <span class="kt">int</span> <span class="n">height</span><span class="o">);</span>
   <span class="kd">static</span> <span class="n">Range</span> <span class="nf">create</span><span class="o">(</span><span class="kt">int</span> <span class="n">width</span><span class="o">,</span> <span class="kt">int</span> <span class="n">height</span><span class="o">,</span> <span class="kt">int</span> <span class="n">passes</span><span class="o">);</span>

<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Range3D</span> <span class="kd">extends</span> <span class="n">Range2D</span><span class="o">{</span>
   <span class="kt">int</span> <span class="n">depth</span><span class="o">;</span>
   <span class="kd">static</span> <span class="n">Range</span> <span class="nf">create</span><span class="o">(</span><span class="kt">int</span> <span class="n">width</span><span class="o">,</span> <span class="kt">int</span> <span class="n">height</span><span class="o">);</span>
   <span class="kd">static</span> <span class="n">Range</span> <span class="nf">create</span><span class="o">(</span><span class="kt">int</span> <span class="n">width</span><span class="o">,</span> <span class="kt">int</span> <span class="n">height</span><span class="o">,</span> <span class="kt">int</span> <span class="n">passes</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div>
<p>With appropriate constructors (or factory methods) to allow</p>
<div class="highlight"><pre class="highlight java"><code>
<span class="n">Kernel</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">Range</span> <span class="n">range</span><span class="o">)</span>
</code></pre></div>
<p>Then execute would be simply.</p>
<div class="highlight"><pre class="highlight java"><code>
<span class="n">Kernel</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">Range</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">1</span><span class="o">))</span>
</code></pre></div>
<p>We can also arrange for the group size to be placed in the base Range class.</p>
<div class="highlight"><pre class="highlight java"><code>
<span class="kd">class</span> <span class="nc">Range</span><span class="o">{</span>
  <span class="kt">int</span> <span class="n">groupSize</span><span class="o">;</span>
  <span class="kt">int</span> <span class="n">passes</span><span class="o">;</span>
  <span class="kt">int</span> <span class="n">width</span><span class="o">;</span>
  <span class="kd">static</span> <span class="n">Range</span> <span class="nf">create</span><span class="o">(</span><span class="kt">int</span> <span class="n">width</span><span class="o">);</span>
  <span class="kd">static</span> <span class="n">Range</span> <span class="nf">create</span><span class="o">(</span><span class="kt">int</span> <span class="n">width</span><span class="o">,</span> <span class="kt">int</span> <span class="n">passes</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div>
<h2>Mapping to OpenCL multi dim methods. i.e get<em>global</em>id(1), get<em>local</em>size(2) etc</h2>

<p>We could just add getGlobalId(int dim), getLocalSize(int dim) etc to replicate OpenCL methods.</p>

<p>I would prefer to offer the following global mappings</p>

<table><thead>
<tr>
<th>Kernel</th>
<th>OpenCL</th>
</tr>
</thead><tbody>
<tr>
<td>getGlobalId()</td>
<td>get<em>global</em>id(0)</td>
</tr>
<tr>
<td>getGlobalX()</td>
<td>get<em>global</em>id(0)</td>
</tr>
<tr>
<td>getGlobalY()</td>
<td>get<em>global</em>id(1)</td>
</tr>
<tr>
<td>getGlobalZ()</td>
<td>get<em>global</em>id(2)</td>
</tr>
<tr>
<td>getGlobalSize()</td>
<td>get<em>global</em>size(0)</td>
</tr>
<tr>
<td>getGlobalWidth()</td>
<td>get<em>global</em>size(0)</td>
</tr>
<tr>
<td>getGlobalHeight()</td>
<td>get<em>global</em>size(1)</td>
</tr>
<tr>
<td>getGlobalDepth()</td>
<td>get<em>global</em>size(2)</td>
</tr>
</tbody></table>

<p>And the following local mappings</p>

<table><thead>
<tr>
<th>Kernel</th>
<th>OpenCL</th>
</tr>
</thead><tbody>
<tr>
<td>getLocalId()</td>
<td>get<em>local</em>id(0)</td>
</tr>
<tr>
<td>getLocalX()</td>
<td>get<em>local</em>id(0)</td>
</tr>
<tr>
<td>getLocalY()</td>
<td>get<em>local</em>id(1)</td>
</tr>
<tr>
<td>getLocalZ()</td>
<td>get<em>local</em>id(2)</td>
</tr>
<tr>
<td>getLocalSize()</td>
<td>get<em>local</em>size(0)</td>
</tr>
<tr>
<td>getLocalWidth()</td>
<td>get<em>local</em>size(0)</td>
</tr>
<tr>
<td>getLocalHeight()</td>
<td>get<em>local</em>size(1)</td>
</tr>
<tr>
<td>getLocalDepth()</td>
<td>get<em>local</em>size(2)</td>
</tr>
</tbody></table>

<h2>An example</h2>
<div class="highlight"><pre class="highlight java"><code>
<span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">WIDTH</span><span class="o">=</span><span class="mi">128</span><span class="o">;</span>
<span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">HEIGHT</span><span class="o">=</span><span class="mi">64</span><span class="o">;</span>
<span class="kd">final</span> <span class="kt">int</span> <span class="n">in</span><span class="o">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="n">WIDTH</span><span class="o">*</span><span class="n">HEIGHT</span><span class="o">];</span>
<span class="kd">final</span> <span class="kt">int</span> <span class="n">out</span><span class="o">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="n">WIDTH</span><span class="o">*</span><span class="n">HEIGHT</span><span class="o">];</span>
<span class="n">Kernel</span> <span class="n">kernel</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Kernel</span><span class="o">(){</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(){</span>
      <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">getGlobalX</span><span class="o">();</span>
      <span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="n">getGlobalY</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(!(</span><span class="n">x</span><span class="o">==</span><span class="mi">1</span> <span class="o">||</span> <span class="n">x</span><span class="o">==(</span><span class="n">getGlobalWidth</span><span class="o">()-</span><span class="mi">1</span><span class="o">)</span> <span class="o">||</span> <span class="n">y</span><span class="o">==</span><span class="mi">1</span> <span class="o">||</span> <span class="n">y</span><span class="o">==(</span><span class="n">getGlobalHeight</span><span class="o">()-</span><span class="mi">1</span><span class="o">)){</span>
         <span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
         <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">dx</span> <span class="o">=-</span><span class="mi">1</span><span class="o">;</span> <span class="n">dx</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">;</span> <span class="n">dx</span><span class="o">++){</span>
           <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">dy</span> <span class="o">=-</span><span class="mi">1</span><span class="o">;</span> <span class="n">dy</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">;</span> <span class="n">dy</span><span class="o">++){</span>
             <span class="n">sum</span><span class="o">+=</span><span class="n">in</span><span class="o">[(</span><span class="n">y</span><span class="o">+</span><span class="n">dy</span><span class="o">)*</span><span class="n">getGlobalWidth</span><span class="o">()+(</span><span class="n">x</span><span class="o">+</span><span class="n">dx</span><span class="o">)];</span>
           <span class="o">}</span>
         <span class="o">}</span>
         <span class="n">out</span><span class="o">[</span><span class="n">y</span><span class="o">*</span><span class="n">getGlobalWidth</span><span class="o">()+</span><span class="n">x</span><span class="o">]</span> <span class="o">=</span> <span class="n">sum</span><span class="o">/</span><span class="mi">9</span><span class="o">;</span>
         <span class="c1">// or out[getGlobalID()] = sum/9;</span>
      <span class="o">}</span>
   <span class="o">}</span>

<span class="o">};</span>
<span class="n">kernel</span><span class="o">.</span><span class="na">executeXY</span><span class="o">(</span><span class="n">WIDTH</span><span class="o">,</span> <span class="n">HEIGHT</span><span class="o">);</span>
</code></pre></div>
<p>Or if we choose the Range class approach.</p>
<div class="highlight"><pre class="highlight java"><code>
<span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">WIDTH</span><span class="o">=</span><span class="mi">128</span><span class="o">;</span>
<span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">HEIGHT</span><span class="o">=</span><span class="mi">64</span><span class="o">;</span>
<span class="kd">final</span> <span class="kt">int</span> <span class="n">in</span><span class="o">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="n">WIDTH</span><span class="o">*</span><span class="n">HEIGHT</span><span class="o">];</span>
<span class="kd">final</span> <span class="kt">int</span> <span class="n">out</span><span class="o">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="n">WIDTH</span><span class="o">*</span><span class="n">HEIGHT</span><span class="o">];</span>
<span class="n">Kernel</span> <span class="n">kernel</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Kernel</span><span class="o">(){</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(){</span>
      <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">getGlobalX</span><span class="o">();</span>
      <span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="n">getGlobalY</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(!(</span><span class="n">x</span><span class="o">==</span><span class="mi">1</span> <span class="o">||</span> <span class="n">x</span><span class="o">==(</span><span class="n">getGlobalWidth</span><span class="o">()-</span><span class="mi">1</span><span class="o">)</span> <span class="o">||</span> <span class="n">y</span><span class="o">==</span><span class="mi">1</span> <span class="o">||</span> <span class="n">y</span><span class="o">==(</span><span class="n">getGlobalHeight</span><span class="o">()-</span><span class="mi">1</span><span class="o">)){</span>
         <span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
         <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">dx</span> <span class="o">=-</span><span class="mi">1</span><span class="o">;</span> <span class="n">dx</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">;</span> <span class="n">dx</span><span class="o">++){</span>
           <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">dy</span> <span class="o">=-</span><span class="mi">1</span><span class="o">;</span> <span class="n">dy</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">;</span> <span class="n">dy</span><span class="o">++){</span>
             <span class="n">sum</span><span class="o">+=</span><span class="n">in</span><span class="o">[(</span><span class="n">y</span><span class="o">+</span><span class="n">dy</span><span class="o">)*</span><span class="n">getGlobalWidth</span><span class="o">()+(</span><span class="n">x</span><span class="o">+</span><span class="n">dx</span><span class="o">)];</span>
           <span class="o">}</span>
         <span class="o">}</span>
         <span class="n">out</span><span class="o">[</span><span class="n">y</span><span class="o">*</span><span class="n">getGlobalWidth</span><span class="o">()+</span><span class="n">x</span><span class="o">]</span> <span class="o">=</span> <span class="n">sum</span><span class="o">/</span><span class="mi">9</span><span class="o">;</span>
         <span class="c1">// or out[getGlobalID()] = sum/9;</span>
      <span class="o">}</span>
   <span class="o">}</span>

<span class="o">};</span>
<span class="n">kernel</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">Range2D</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">WIDTH</span><span class="o">,</span> <span class="n">HEIGHT</span><span class="o">));</span>
</code></pre></div>
<h2>Handling this from JTP mode</h2>

<p>Mapping to OpenCL for this is all fairly straightforward.</p>

<p>In Java JTP mode we will have to emulate this. For <code>get_global_id(0..3)</code> (<code>getGlobalX()</code>, <code>getGlobalY()</code> and <code>getGlobalZ()</code> using our proposed Aparapi Java mappings) we can of course easily offer reasonable implementations, this just requires the Java code to essentially nest 3 loops (or emulate) and set <code>globalX</code>, <code>globalY</code>, <code>globalZ</code> inside each nesting.</p>

<p>For <code>get_local_size(0..3)</code> (<code>getLocalWidth()</code>, <code>getLocalHeight()</code> and <code>getLocalDepth()</code> using our proposed Aparapi Java mappings) we will need to break the globalWidth/globalHeight and globalDepth into some arbitrary equal &lsquo;chunks&rsquo; (note I am avoiding using the word groups here to avoid confusion with <code>get_group_size(0..3)</code>!</p>

<p>At present we always create a synthetic group in JTP mode which is the the # or cores. This will need to be changed. If the user requests a grid (64,64,8,8) (global width 64, global height 64, local width 8, local height 8) then we will have to create a JTP group of 64 (8x8) and just in case the kernel code contains a barrier, we will need to ensure we launch 64 threads for this group. From our experience it is best to launch one thread per core, so we may lose some JTP performance executing in this mode.</p>

</div>
</main>
<footer class='page-footer'>
<div class='container'>
<div class='row'>
<div class='col l4 s12'>
<h5 class='white-text'>Help Aparapi Grow</h5>
<p class='grey-text text-lighten-4'>We are a team of volunteers working on this project like it's our full time job. Any amount would help support and continue development on this project and is greatly appreciated.</p>
<form action='https://www.paypal.com/cgi-bin/webscr' id='paypal-donate' method='post' target='_top'>
<input name='cmd' type='hidden' value='_s-xclick'>
<input name='hosted_button_id' type='hidden' value='EGPN4CSPCW9JN'>
<button alt='PayPal - The safer, easier way to pay online!' class='btn waves-effect waves-light red lighten-3' name='action' type='submit'>
Donate Now
</button>
</form>
</div>
<div class='col l4 s12'>
<h5 class='white-text'>Join the Discussion</h5>
<p class='grey-text text-lighten-4'>We have a Gitter chat room set up where you can talk directly with us. Come in and discuss new features, future goals, general problems or questions, or anything else you can think of.</p>
<a class='btn waves-effect waves-light red lighten-3' href='https://gitter.im/Syncleus/aparapi' target='_blank'>Chat</a>
</div>
<div class='col l4 s12' style='overflow: hidden;'>
<h5 class='white-text'>Connect</h5>
<iframe allowtransparency='true' frameborder='0' height='30' scrolling='0' src='http://ghbtns.com/github-btn.html?user=Syncleus&amp;repo=aparapi&amp;type=watch&amp;count=true&amp;size=large' width='170'></iframe>
<br>
<a class='twitter-follow-button' data-dnt='true' data-show-count='true' data-size='large' href='https://twitter.com/AparapiLib'>Follow @AparapiLib</a>
<br>
<div class='g-follow' data-annotation='bubble' data-height='24' data-href='https://plus.google.com/102266131584900704956' data-rel='publisher'></div>
</div>
</div>
</div>
<div class='footer-copyright'>
<div class='container'>
Â© 2016-2017 Syncleus, All rights reserved.
<a class='grey-text text-lighten-4 right' href='https://github.com/Syncleus/aparapi/blob/master/LICENSE'>Apache License v2</a>
</div>
</div>
</footer>
<!-- Scripts -->
<script src='https://code.jquery.com/jquery-2.1.4.min.js'></script>
<script>
  if (!window.jQuery) { document.write('<script src="bin/jquery-2.1.1.min.js"><\/script>'); }
</script>
<script src='/javascripts/jquery.timeago.js'></script>
<script src='/javascripts/materialize.min.js'></script>
<script src='/javascripts/lunr.min.js'></script>
<script src='/javascripts/search.js'></script>
<script src='/javascripts/materialize.js'></script>
<script src='/javascripts/init.js'></script>
<!-- Twitter Button -->
<script>
  !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');
</script>
<!-- Google Plus Button -->
<script async='' defer='defer' src='https://apis.google.com/js/platform.js'></script>
</body>
</html>
